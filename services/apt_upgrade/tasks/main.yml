---
# Main tasks for apt_upgrade service

- name: Perform apt upgrades
  when: not (apt_upgrade_fastdeploy_enabled | default(false))
  block:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: "{{ apt_upgrade_cache_valid_time }}"
      when: apt_upgrade_update_cache

    - name: Perform dist-upgrade
      apt:
        upgrade: dist
        autoclean: "{{ apt_upgrade_auto_clean }}"
        autoremove: "{{ apt_upgrade_auto_remove }}"
      when: apt_upgrade_dist_upgrade
      register: upgrade_result

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Report reboot requirement
      debug:
        msg: "System reboot required: {{ reboot_required.stat.exists }}"

# FastDeploy integration tasks
- name: Setup FastDeploy integration
  when: apt_upgrade_fastdeploy_enabled | default(false)
  block:
    - name: Ensure deploy user exists
      user:
        name: "{{ apt_upgrade_deploy_user }}"
        system: yes
        shell: /bin/bash
      become: yes

    - name: Ensure deploy user is in fastdeploy group
      user:
        name: "{{ apt_upgrade_deploy_user }}"
        groups: "{{ apt_upgrade_fastdeploy_user }}"
        append: yes
      become: yes

    - name: Create service directory
      file:
        path: "{{ apt_upgrade_service_path }}"
        state: directory
        owner: "{{ apt_upgrade_fastdeploy_user }}"
        group: "{{ apt_upgrade_fastdeploy_user }}"
        mode: "0755"
      become: yes

    - name: Deploy fastDeploy config
      template:
        src: fastdeploy/config.json.j2
        dest: "{{ apt_upgrade_service_path }}/config.json"
        owner: "{{ apt_upgrade_fastdeploy_user }}"
        group: "{{ apt_upgrade_fastdeploy_user }}"
        mode: "0644"
      become: yes

    - name: Deploy Python script
      template:
        src: fastdeploy/deploy.py.j2
        dest: "{{ apt_upgrade_service_path }}/deploy.py"
        owner: "{{ apt_upgrade_fastdeploy_user }}"
        group: "{{ apt_upgrade_fastdeploy_user }}"
        mode: "0755"
      become: yes

    - name: Deploy wrapper shell script
      template:
        src: fastdeploy/deploy.sh.j2
        dest: "{{ apt_upgrade_service_path }}/deploy.sh"
        owner: "{{ apt_upgrade_fastdeploy_user }}"
        group: "{{ apt_upgrade_fastdeploy_user }}"
        mode: "0755"
      become: yes

    - name: Deploy ansible playbook
      template:
        src: fastdeploy/playbook.yml.j2
        dest: "{{ apt_upgrade_service_path }}/playbook.yml"
        owner: "{{ apt_upgrade_fastdeploy_user }}"
        group: "{{ apt_upgrade_fastdeploy_user }}"
        mode: "0644"
      become: yes

    - name: Create sudoers file for deploy script
      template:
        src: fastdeploy/sudoers.j2
        dest: /etc/sudoers.d/apt_upgrade_fastdeploy
        mode: '0440'
      become: yes