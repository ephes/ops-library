---
- name: Remove staging directory
  ansible.builtin.file:
    path: "{{ paperless_restore_staging_path }}"
    state: absent
  when:
    - paperless_restore_staging_path is defined
    - paperless_restore_staging_path | length > 0
    - paperless_restore_operation_successful | bool or paperless_restore_dry_run | bool

- name: Remove safety snapshot after successful restore
  ansible.builtin.file:
    path: "{{ paperless_restore_safety_backup_path }}"
    state: absent
  when:
    - paperless_restore_safety_backup_path is defined
    - paperless_restore_safety_backup_path | length > 0
    - paperless_restore_create_safety_backup | bool
    - paperless_restore_safety_backup_cleanup | bool
    - paperless_restore_operation_successful | bool
    - not paperless_restore_rollback_executed | bool

- name: Clean up safety snapshot after rollback
  ansible.builtin.file:
    path: "{{ paperless_restore_safety_backup_path }}"
    state: absent
  when:
    - paperless_restore_safety_backup_path is defined
    - paperless_restore_safety_backup_path | length > 0
    - paperless_restore_rollback_executed | bool
    - paperless_restore_cleanup_after_rollback | bool

- name: Restore summary
  ansible.builtin.debug:
    msg: >-
      Paperless restore {{ 'dry-run validation' if paperless_restore_dry_run | bool
      else ('completed successfully' if paperless_restore_operation_successful | bool else 'failed') }}.
      Archive: {{ paperless_restore_archive_path | default('unknown') }}.
      Safety snapshot: {{ paperless_restore_safety_backup_path | default('n/a') }}.
