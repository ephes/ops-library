# Managed by Ansible - Traefik configuration for Vaultwarden
# Vaultwarden requires WebSocket support for live sync

http:
  routers:
    # Main Vaultwarden router (HTTPS)
    vaultwarden:
      rule: "Host(`{{ vaultwarden_hostname }}`)"
      entryPoints:
        - {{ vaultwarden_traefik_entrypoint }}
      middlewares:
        - vaultwarden-headers
      service: vaultwarden
{% if vaultwarden_traefik_certresolver | default('') | length > 0 %}
      tls:
        certResolver: {{ vaultwarden_traefik_certresolver }}
{% else %}
      tls: {}
{% endif %}

{% if vaultwarden_websocket_enabled %}
    # WebSocket router for live sync notifications
    vaultwarden-ws:
      rule: "Host(`{{ vaultwarden_hostname }}`) && Path(`/notifications/hub`)"
      entryPoints:
        - {{ vaultwarden_traefik_entrypoint }}
      middlewares:
        - vaultwarden-headers
      service: vaultwarden-ws
{% if vaultwarden_traefik_certresolver | default('') | length > 0 %}
      tls:
        certResolver: {{ vaultwarden_traefik_certresolver }}
{% else %}
      tls: {}
{% endif %}
{% endif %}

    # HTTP to HTTPS redirect
    vaultwarden-http:
      rule: "Host(`{{ vaultwarden_hostname }}`)"
      entryPoints:
        - web
      middlewares:
        - vaultwarden-redirect
      service: vaultwarden

  middlewares:
    vaultwarden-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: SAMEORIGIN
        customRequestHeaders:
          X-Forwarded-Proto: https
          X-Forwarded-Host: "{{ vaultwarden_hostname }}"

    vaultwarden-redirect:
      redirectScheme:
        scheme: https
        permanent: true

  services:
    vaultwarden:
      loadBalancer:
        servers:
          - url: "http://{{ vaultwarden_rocket_address }}:{{ vaultwarden_rocket_port }}"

{% if vaultwarden_websocket_enabled %}
    vaultwarden-ws:
      loadBalancer:
        servers:
          - url: "http://{{ vaultwarden_rocket_address }}:{{ vaultwarden_websocket_port }}"
{% endif %}
