---
# Stop DNS Services

- name: Stop and disable DNS services
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    daemon_reload: yes
  loop: "{{ dns_services_to_stop }}"
  register: service_stop_result
  failed_when: false
  ignore_errors: yes
  async: 30  # Don't wait more than 30 seconds
  poll: 5

- name: Force kill services if still running
  shell: |
    if systemctl is-active {{ item }} >/dev/null 2>&1; then
      systemctl kill -s KILL {{ item }} || true
    fi
  loop: "{{ dns_services_to_stop }}"
  failed_when: false
  changed_when: false

- name: Report service status
  debug:
    msg: "Service {{ item.item }} processing complete"
  loop: "{{ service_stop_result.results | default([]) }}"
  when: service_stop_result.results is defined