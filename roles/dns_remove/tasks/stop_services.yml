---
# Stop DNS Services

- name: Stop and disable Unbound services
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    daemon_reload: yes
  loop:
    - unbound
    - unbound-blocklist.timer
    - unbound-blocklist.service
  register: service_stop_result
  failed_when: false
  ignore_errors: yes
  async: 30
  poll: 5

- name: Force kill services if still running
  shell: |
    if systemctl is-active {{ item }} >/dev/null 2>&1; then
      systemctl kill -s KILL {{ item }} || true
    fi
  loop:
    - unbound
  failed_when: false
  changed_when: false