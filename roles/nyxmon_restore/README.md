# Nyxmon Restore Role

Restores a Nyxmon deployment from archives produced by `nyxmon_backup`.

## Features

- Automatically selects the latest archive (or a named archive) under `/opt/backups/nyxmon`.
- Validates `metadata.yml` and `manifest.sha256`, checks disk space, and supports dry-run verification.
- Creates a safety snapshot of `/home/nyxmon/site` before applying changes for quick manual rollback.
- Stops both `nyxmon.service` and `nyxmon-monitor.service`, restores SQLite/database/config/media/logs, and optionally systemd + Traefik files.
- Restarts services, runs Django + SQLite checks, and probes the HTTP endpoint before cleaning up staging/safety directories.
- Wraps restore operations in a block/rescue so failures automatically roll back to the safety snapshot.

## Requirements

- Root/become privileges on the host.
- Backup archives generated by `nyxmon_backup`.
- Tools: `tar`, `rsync`, `sqlite3`, `sha256sum`.

## Key Variables

```yaml
nyxmon_restore_archive: latest
nyxmon_restore_archive_search_root: /opt/backups/nyxmon
nyxmon_restore_local_cache: "{{ lookup('env','HOME') }}/backups/nyxmon"
nyxmon_restore_validate_checksums: true
nyxmon_restore_dry_run: false
nyxmon_restore_create_safety_backup: true
nyxmon_restore_cleanup_safety_backup: true
nyxmon_restore_verify_http: true
nyxmon_restore_health_url: http://127.0.0.1:10017/admin/login/
nyxmon_restore_dirs:
  - { name: media,  src: media,  dest: /home/nyxmon/site/media,      optional: false }
  - { name: static, src: static, dest: /home/nyxmon/site/staticfiles, optional: true }
  - { name: cache,  src: cache,  dest: /home/nyxmon/site/cache,      optional: true }
  - { name: logs,   src: logs,   dest: /home/nyxmon/logs,            optional: true }
```

## Example Playbook

```yaml
- name: Restore Nyxmon from the latest backup
  hosts: macmini
  become: true
  roles:
    - role: local.ops_library.nyxmon_restore
      vars:
        nyxmon_restore_archive: latest
```
