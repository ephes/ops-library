---
# Configure Postfix to use rspamd milter (chained with existing milters like OpenDKIM)
# Uses relative path for chrooted Postfix compatibility

- name: Get current smtpd_milters value
  ansible.builtin.command:
    cmd: postconf -h smtpd_milters
  register: current_smtpd_milters
  changed_when: false
  failed_when: false

# Build clean milter list: remove old absolute path, add new relative path
- name: Build cleaned milter list
  ansible.builtin.set_fact:
    # Split by comma, trim whitespace, filter out old absolute path and empty strings
    _milters_cleaned: >-
      {{ (current_smtpd_milters.stdout | default(''))
         | split(',')
         | map('trim')
         | reject('equalto', '')
         | reject('equalto', 'unix:/var/lib/rspamd/milter.sock')
         | reject('equalto', 'unix:' ~ mail_spam_milter_socket_postfix)
         | list }}

- name: Build final milter list with rspamd
  ansible.builtin.set_fact:
    _milters_final: "{{ _milters_cleaned + ['unix:' ~ mail_spam_milter_socket_postfix] }}"

- name: Set smtpd_milters in Postfix
  ansible.builtin.lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^smtpd_milters\\s*="
    line: "smtpd_milters = {{ _milters_final | join(', ') }}"
    backup: true
  notify: Reload postfix

- name: Set non_smtpd_milters to match smtpd_milters
  ansible.builtin.lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^non_smtpd_milters\\s*="
    line: "non_smtpd_milters = $smtpd_milters"
    backup: true
  notify: Reload postfix

- name: Set milter default action
  ansible.builtin.lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^milter_default_action\\s*="
    line: "milter_default_action = accept"
    backup: true
  notify: Reload postfix

- name: Set milter protocol
  ansible.builtin.lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^milter_protocol\\s*="
    line: "milter_protocol = 6"
    backup: true
  notify: Reload postfix
