---
# Configure rspamd

- name: Ensure rspamd config directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: _rspamd
    group: _rspamd
    mode: "0755"
  loop:
    - "{{ mail_spam_local_config_path }}"
    - "{{ mail_spam_override_config_path }}"

- name: Configure Redis
  ansible.builtin.template:
    src: local.d/redis.conf.j2
    dest: "{{ mail_spam_local_config_path }}/redis.conf"
    owner: _rspamd
    group: _rspamd
    mode: "0644"
  notify: Restart rspamd
  when: mail_spam_redis_enabled

- name: Configure worker-normal
  ansible.builtin.template:
    src: local.d/worker-normal.inc.j2
    dest: "{{ mail_spam_local_config_path }}/worker-normal.inc"
    owner: _rspamd
    group: _rspamd
    mode: "0644"
  notify: Restart rspamd

- name: Configure worker-proxy (milter)
  ansible.builtin.template:
    src: local.d/worker-proxy.inc.j2
    dest: "{{ mail_spam_local_config_path }}/worker-proxy.inc"
    owner: _rspamd
    group: _rspamd
    mode: "0644"
  notify: Restart rspamd

- name: Generate rspamd web UI password hash
  ansible.builtin.command:
    cmd: rspamadm pw -p "{{ mail_spam_web_password }}"
  register: rspamadm_pw_result
  changed_when: false
  no_log: true
  when:
    - mail_spam_web_enabled
    - mail_spam_web_password is defined
    - mail_spam_web_password | length > 0

- name: Set rspamd web password hash fact
  ansible.builtin.set_fact:
    mail_spam_web_password_hash: "{{ rspamadm_pw_result.stdout }}"
  when:
    - mail_spam_web_enabled
    - rspamadm_pw_result is defined
    - rspamadm_pw_result.stdout is defined

- name: Configure worker-controller (web UI)
  ansible.builtin.template:
    src: local.d/worker-controller.inc.j2
    dest: "{{ mail_spam_local_config_path }}/worker-controller.inc"
    owner: _rspamd
    group: _rspamd
    mode: "0644"
  notify: Restart rspamd
  when: mail_spam_web_enabled

- name: Configure actions
  ansible.builtin.template:
    src: local.d/actions.conf.j2
    dest: "{{ mail_spam_local_config_path }}/actions.conf"
    owner: _rspamd
    group: _rspamd
    mode: "0644"
  notify: Restart rspamd

- name: Configure milter headers
  ansible.builtin.template:
    src: local.d/milter_headers.conf.j2
    dest: "{{ mail_spam_local_config_path }}/milter_headers.conf"
    owner: _rspamd
    group: _rspamd
    mode: "0644"
  notify: Restart rspamd

- name: Configure classifier-bayes
  ansible.builtin.template:
    src: local.d/classifier-bayes.conf.j2
    dest: "{{ mail_spam_local_config_path }}/classifier-bayes.conf"
    owner: _rspamd
    group: _rspamd
    mode: "0644"
  notify: Restart rspamd
  when: mail_spam_redis_enabled

- name: Add postfix to rspamd group
  ansible.builtin.user:
    name: postfix
    groups: _rspamd
    append: true
  notify: Restart postfix
