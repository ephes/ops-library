// Managed by Ansible (telegram_bot_deploy). Do not edit on the host.
import { Bot } from 'grammy';

const TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const API_KEY = process.env.ANTHROPIC_API_KEY;
const MODEL = process.env.ANTHROPIC_MODEL || 'claude-sonnet-4-20250514';
const SYSTEM_PROMPT = process.env.SYSTEM_PROMPT || 'You are a helpful assistant. Be concise.';
const MAX_TOKENS = parseInt(process.env.MAX_TOKENS || '1024', 10);
const ALLOWED_USERS = process.env.ALLOWED_USERS || '';
const MAX_INPUT_LENGTH = 4000;
const MAX_HISTORY = 40; // 20 turns
const TELEGRAM_MAX_LENGTH = 4096;

const allowedSet = new Set(
  ALLOWED_USERS.split(',').map(s => s.trim()).filter(Boolean).map(Number)
);

// Per-user conversation history
const history = new Map();

const bot = new Bot(TOKEN);

// Access control middleware
if (allowedSet.size > 0) {
  bot.use(async (ctx, next) => {
    if (ctx.from && allowedSet.has(ctx.from.id)) {
      return next();
    }
    console.log(`Blocked message from user ${ctx.from?.id} (${ctx.from?.username || 'unknown'})`);
  });
}

bot.command('start', async (ctx) => {
  await ctx.reply('Hello! Send me a message and I will reply using AI. Use /new to reset the conversation.');
});

bot.command('new', async (ctx) => {
  history.delete(ctx.from.id);
  await ctx.reply('Conversation reset.');
});

bot.on('message:text', async (ctx) => {
  const userId = ctx.from.id;
  let text = ctx.message.text;
  if (text.length > MAX_INPUT_LENGTH) {
    text = text.slice(0, MAX_INPUT_LENGTH);
  }

  // Build conversation history
  if (!history.has(userId)) {
    history.set(userId, []);
  }
  const messages = history.get(userId);
  messages.push({ role: 'user', content: text });

  // Trim to max history
  while (messages.length > MAX_HISTORY) {
    messages.shift();
  }

  // Show typing indicator
  await ctx.replyWithChatAction('typing');
  const typingInterval = setInterval(() => {
    ctx.replyWithChatAction('typing').catch(() => {});
  }, 4000);

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      signal: AbortSignal.timeout(60_000),
      headers: {
        'x-api-key': API_KEY,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json',
      },
      body: JSON.stringify({
        model: MODEL,
        max_tokens: MAX_TOKENS,
        system: SYSTEM_PROMPT,
        messages,
      }),
    });

    if (!resp.ok) {
      const body = await resp.text();
      console.error(`Anthropic API error ${resp.status}: ${body}`);
      await ctx.reply('Sorry, something went wrong with the AI service.');
      return;
    }

    const data = await resp.json();
    const reply = data.content?.[0]?.text || 'No response from AI.';

    // Store assistant reply in history
    messages.push({ role: 'assistant', content: reply });
    while (messages.length > MAX_HISTORY) {
      messages.shift();
    }

    // Split long messages for Telegram's 4096 char limit
    if (reply.length <= TELEGRAM_MAX_LENGTH) {
      await ctx.reply(reply);
    } else {
      for (let i = 0; i < reply.length; i += TELEGRAM_MAX_LENGTH) {
        await ctx.reply(reply.slice(i, i + TELEGRAM_MAX_LENGTH));
      }
    }
  } catch (err) {
    console.error('Error calling Anthropic API:', err.message);
    await ctx.reply('Sorry, the request timed out or failed. Please try again.');
  } finally {
    clearInterval(typingInterval);
  }
});

// Graceful shutdown
function shutdown(signal) {
  console.log(`Received ${signal}, stopping bot...`);
  bot.stop();
}
process.on('SIGINT', () => shutdown('SIGINT'));
process.on('SIGTERM', () => shutdown('SIGTERM'));

// Start long polling
bot.start({
  onStart: (info) => console.log(`Bot @${info.username} started (long polling)`),
});
