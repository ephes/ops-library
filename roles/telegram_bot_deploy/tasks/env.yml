---
- name: Assemble Telegram Bot environment
  ansible.builtin.set_fact:
    telegram_bot_env: "{{ telegram_bot_env_defaults | combine(telegram_bot_extra_env, recursive=True) }}"
  no_log: true
  vars:
    telegram_bot_env_defaults:
      TELEGRAM_BOT_TOKEN: "{{ telegram_bot_token }}"
      ANTHROPIC_API_KEY: "{{ telegram_bot_anthropic_api_key }}"
      ANTHROPIC_MODEL: "{{ telegram_bot_anthropic_model }}"
      SYSTEM_PROMPT: "{{ telegram_bot_system_prompt }}"
      MAX_TOKENS: "{{ telegram_bot_max_tokens }}"
      ALLOWED_USERS: "{{ telegram_bot_allowed_users }}"

- name: Render Telegram Bot environment file
  ansible.builtin.template:
    src: telegram-bot.env.j2
    dest: "{{ telegram_bot_site_dir }}/.env"
    owner: root
    group: root
    mode: "0600"
  no_log: true
  notify: restart telegram-bot
