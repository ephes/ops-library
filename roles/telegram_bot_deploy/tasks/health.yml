---
- name: Check Telegram Bot container is running
  ansible.builtin.command:
    cmd: >
      docker compose -f {{ telegram_bot_site_dir }}/docker-compose.yml
      ps --format json {{ telegram_bot_container_name }}
  register: telegram_bot_health
  retries: "{{ telegram_bot_healthcheck_retries }}"
  delay: "{{ telegram_bot_healthcheck_delay }}"
  until: telegram_bot_health.rc == 0 and '"running"' in telegram_bot_health.stdout
  changed_when: false

- name: Verify Telegram Bot started (check recent logs)
  ansible.builtin.command:
    cmd: "docker logs {{ telegram_bot_container_name }} --tail 10"
  register: telegram_bot_logs
  changed_when: false
  failed_when: >
    telegram_bot_logs.rc != 0
    or 'Error' in (telegram_bot_logs.stdout + telegram_bot_logs.stderr)
    or 'FATAL' in (telegram_bot_logs.stdout + telegram_bot_logs.stderr)
