---
- name: Validate removal settings
  ansible.builtin.import_tasks: validate.yml

- name: Stop Open WebUI systemd service
  ansible.builtin.systemd:
    name: "{{ open_webui_service_name }}"
    state: stopped
    enabled: false
    daemon_reload: true
  failed_when: false

- name: Remove Open WebUI systemd unit
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ open_webui_service_name }}.service"
    state: absent
  notify: reload systemd

- name: Remove Open WebUI Traefik configuration
  ansible.builtin.file:
    path: "{{ open_webui_traefik_config_path }}"
    state: absent
  when: open_webui_remove_traefik_config | bool
  notify: reload traefik

- name: Remove Open WebUI compose/env files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ open_webui_env_file }}"
    - "{{ open_webui_compose_path }}"
  when: open_webui_remove_compose_files | bool

- name: Remove Open WebUI site directory
  ansible.builtin.file:
    path: "{{ open_webui_site_dir }}"
    state: absent
  when: open_webui_remove_site_dir | bool

- name: Remove Open WebUI data directory
  ansible.builtin.file:
    path: "{{ open_webui_data_dir }}"
    state: absent
  when: open_webui_remove_data | bool

- name: Remove Open WebUI data parent directory
  ansible.builtin.file:
    path: "{{ open_webui_data_parent_dir }}"
    state: absent
  when: open_webui_remove_data_parent | bool

- name: Remove Open WebUI user
  ansible.builtin.user:
    name: "{{ open_webui_user }}"
    state: absent
    remove: true
  when: open_webui_remove_user | bool

- name: Remove Open WebUI group
  ansible.builtin.group:
    name: "{{ open_webui_group }}"
    state: absent
  when: open_webui_remove_group | bool

- name: Apply pending handlers
  ansible.builtin.meta: flush_handlers
