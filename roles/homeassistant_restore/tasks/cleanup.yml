---
- name: Remove staging directory
  ansible.builtin.file:
    path: "{{ homeassistant_restore_staging_path }}"
    state: absent
  when: homeassistant_restore_staging_path is defined

- name: Remove pre-restore snapshot after success
  ansible.builtin.file:
    path: "{{ homeassistant_restore_safety_backup_path }}"
    state: absent
  when:
    - homeassistant_restore_safety_backup_path is defined
    - homeassistant_restore_create_safety_backup | bool
    - homeassistant_restore_cleanup_safety_backup | bool
    - homeassistant_restore_operation_successful | bool
    - not homeassistant_restore_rollback_executed | bool

- name: Clean up snapshot after rollback when configured
  ansible.builtin.file:
    path: "{{ homeassistant_restore_safety_backup_path }}"
    state: absent
  when:
    - homeassistant_restore_safety_backup_path is defined
    - homeassistant_restore_rollback_executed | bool
    - homeassistant_restore_cleanup_after_rollback | bool

- name: Restore summary
  ansible.builtin.debug:
    msg: >-
      Home Assistant restore {{ 'validation (dry-run only)' if homeassistant_restore_dry_run | bool
      else ('completed successfully' if homeassistant_restore_operation_successful | bool else 'failed') }}.
      Archive: {{ homeassistant_restore_archive_path | default('unknown') }}
      Rollback executed: {{ homeassistant_restore_rollback_executed | bool }}
