---
# Request or update certificate using DNS-01

- name: Build domain list
  ansible.builtin.set_fact:
    certbot_dns_domains: >-
      {{
        (
          ((certbot_dns_include_base | bool) | ternary([certbot_dns_domain], []))
          + ((certbot_dns_wildcard | bool) | ternary(["*." + certbot_dns_domain], []))
          + (certbot_dns_additional_domains | default([]))
        ) | unique
      }}

- name: Validate domain list is not empty
  ansible.builtin.assert:
    that:
      - certbot_dns_domains | length > 0
    fail_msg: "No domains requested for certificate"

- name: Assemble domain arguments
  ansible.builtin.set_fact:
    certbot_dns_domain_args: "{{ certbot_dns_domains | map('regex_replace', '^(.*)$', '-d \\1') | list }}"

- name: Request certificate via DNS challenge
  ansible.builtin.command:
    argv: >-
      {{
        [
          "certbot",
          "certonly",
          "--non-interactive",
          "--agree-tos",
          "--email", certbot_dns_email,
          "--authenticator", "dns-" + certbot_dns_provider,
          "--dns-" + certbot_dns_provider + "-credentials", certbot_dns_credentials_file,
          "--dns-" + certbot_dns_provider + "-propagation-seconds", certbot_dns_propagation_seconds | string,
          "--cert-name", certbot_dns_domain,
          "--key-type", certbot_dns_key_type,
          "--keep-until-expiring",
          "--expand"
        ]
        + (certbot_dns_staging | bool | ternary(["--staging"], []))
        + certbot_dns_domain_args
      }}
  register: certbot_dns_request
  changed_when: >
    (
      'not yet due for renewal' not in (
        (certbot_dns_request.stdout | default('')) +
        (certbot_dns_request.stderr | default(''))
      )
    )
  become: yes
