# Postfix main.cf - Edge Relay Configuration
# Generated by Ansible - do not edit manually
# Role: mail_relay_deploy

# =============================================================================
# Basic Settings
# =============================================================================

# Hostname (must match PTR record for HELO alignment)
myhostname = {{ mail_relay_hostname }}
mydomain = {{ mail_relay_mydomain }}
myorigin = $mydomain

# Network settings
inet_interfaces = {{ mail_relay_inet_interfaces }}
inet_protocols = {{ mail_relay_inet_protocols }}

# This is a relay, not a final destination
mydestination =
local_recipient_maps =
local_transport = error:local delivery disabled

# Trusted networks (for open relay prevention)
mynetworks = {{ mail_relay_mynetworks | join(', ') }}

# =============================================================================
# Relay Configuration
# =============================================================================

# Domains we relay mail FOR (inbound)
relay_domains = hash:/etc/postfix/relay_domains

# Transport map for routing to backend
transport_maps = hash:/etc/postfix/transport

# Optional recipient canonical rewrites (e.g. Unicode IDN -> punycode)
{% if mail_relay_recipient_rewrites | length > 0 %}
recipient_canonical_maps = hash:/etc/postfix/recipient_canonical
recipient_canonical_classes = envelope_recipient
{% endif %}

# Do NOT set relayhost here - we use transport_maps for inbound relay
# Outbound mail from submission goes directly to destination

# =============================================================================
# TLS Configuration - Inbound (receiving mail)
# =============================================================================

{% if mail_relay_tls_enabled %}
smtpd_tls_security_level = {{ mail_relay_smtpd_tls_security_level }}
smtpd_tls_cert_file = {{ mail_relay_tls_cert }}
smtpd_tls_key_file = {{ mail_relay_tls_key }}
smtpd_tls_protocols = {{ mail_relay_tls_protocols }}
smtpd_tls_mandatory_protocols = {{ mail_relay_tls_protocols }}
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes
{% endif %}

# =============================================================================
# TLS Configuration - Outbound (sending mail)
# =============================================================================

{% if mail_relay_tls_enabled %}
smtp_tls_security_level = {{ mail_relay_smtp_tls_security_level }}
smtp_tls_protocols = {{ mail_relay_tls_protocols }}
smtp_tls_mandatory_protocols = {{ mail_relay_tls_protocols }}
smtp_tls_loglevel = 1
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt

# Per-destination TLS policy (enforce TLS for backend hop)
smtp_tls_policy_maps = hash:/etc/postfix/tls_policy
{% endif %}

# =============================================================================
# SASL Authentication (for submission port)
# =============================================================================

# Enable SASL for submission (authenticated relay from backend)
smtpd_sasl_auth_enable = yes
smtpd_sasl_type = cyrus
smtpd_sasl_path = smtpd
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname

# =============================================================================
# Relay Restrictions
# =============================================================================

# Inbound restrictions (port 25)
smtpd_relay_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination

smtpd_recipient_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
{% if mail_relay_greylisting_enabled %}
    check_policy_service inet:127.0.0.1:{{ mail_relay_greylisting_port }},
{% endif %}
    reject_unauth_destination

smtpd_sender_restrictions =
    reject_unknown_sender_domain

smtpd_helo_required = yes
smtpd_helo_restrictions =
    permit_mynetworks,
    reject_invalid_helo_hostname,
    reject_non_fqdn_helo_hostname

# =============================================================================
# Rate Limiting
# =============================================================================

smtpd_client_connection_rate_limit = {{ mail_relay_client_connection_rate_limit }}
smtpd_client_recipient_rate_limit = {{ mail_relay_client_recipient_rate_limit }}
smtpd_recipient_limit = {{ mail_relay_smtpd_recipient_limit }}

# =============================================================================
# Misc Settings
# =============================================================================

# Mailbox size limit (0 = unlimited, we're just relaying)
mailbox_size_limit = 0
message_size_limit = 52428800

# Queue settings
maximal_queue_lifetime = 5d
bounce_queue_lifetime = 5d

# SMTPUTF8 support (disabled by default; backend delivery path is ASCII/punycode only)
smtputf8_enable = {{ 'yes' if mail_relay_smtputf8_enable else 'no' }}

# Logging
maillog_file = {{ mail_relay_maillog_file }}

# Compatibility
compatibility_level = 3.6

# Disable local delivery
alias_maps =
alias_database =
