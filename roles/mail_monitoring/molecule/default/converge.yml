---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Ensure Ansible remote tmp exists
      ansible.builtin.file:
        path: /tmp/.ansible/tmp
        state: directory
        mode: "0700"

  vars:
    postfixadmin_db_password: "molecule-test-password"
    postfixadmin_setup_password_hash: "$2y$10$abcdefghijklmnopqrstuuVWXYZ0123456789ABCDEFGHIJKLMNOPQx"
    postfixadmin_admin_password_hash: "{SHA512-CRYPT}$6$rounds=5000$moleculetestsalt$Y8qJk9vN5tL2mH3wX7yR4pC6oA1iB8eD0fG2jK5lM9nO3qS6uV7wZ0xC1dE4fG7hJ0kL2mN5oP8qR1sT4uV7wX"
    postfixadmin_admin_email: "admin@example.test"
    postfixadmin_traefik_enabled: false
    postfixadmin_healthcheck_enabled: false
    postfixadmin_listen_port: 8082
    postfixadmin_backup_path: "/tmp/postfixadmin-backups"
    postfixadmin_totp_enabled: false

  roles:
    - role: postfixadmin_deploy

  post_tasks:
    - name: Ensure domain exists for mailbox
      become: true
      become_user: postgres
      community.postgresql.postgresql_query:
        db: mail
        query: |
          INSERT INTO domain (domain, description, aliases, mailboxes, maxquota, quota, transport, backupmx, active, created, modified)
          VALUES (%(domain)s, '', 0, 0, 0, 0, 'virtual', false, true, NOW(), NOW())
          ON CONFLICT (domain) DO NOTHING
        named_args:
          domain: "example.test"

    - name: Enable mail_monitoring role
      include_role:
        name: mail_monitoring
      vars:
        mail_monitoring_enabled: true
        mail_monitoring_schema_mode: "postfixadmin"
        mail_monitoring_postgres_database: "mail"
        mail_monitoring_address: "monitor@example.test"
        mail_monitoring_password: "molecule-monitor-password"
        mail_monitoring_vmail_path: "/tmp/vmail"
        mail_monitoring_vmail_user: "vmail"
        mail_monitoring_vmail_group: "vmail"
        mail_monitoring_cleanup_ttl_days: 1
