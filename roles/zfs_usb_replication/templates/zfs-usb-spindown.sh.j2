#!/usr/bin/env bash
set -euo pipefail

pool="{{ zfs_usb_replication_spindown_pool }}"
spindown_device_count={{ zfs_usb_replication_spindown_devices | length }}

{% if zfs_usb_replication_spindown_devices | length > 0 %}
spindown_devices=(
{% for device in zfs_usb_replication_spindown_devices %}
  "{{ device }}"
{% endfor %}
)
{% else %}
spindown_devices=()
{% endif %}

if [[ -n "${pool}" ]]; then
  if command -v zpool >/dev/null 2>&1; then
    stats=$(zpool iostat -H -p "${pool}" 1 2 | tail -n 1 || true)
    if [[ -n "${stats}" ]]; then
      read -r _pool _alloc _free read_ops write_ops read_bytes write_bytes <<<"${stats}"
      if [[ "${read_ops:-0}" != "0" || "${write_ops:-0}" != "0" || "${read_bytes:-0}" != "0" || "${write_bytes:-0}" != "0" ]]; then
        logger -t zfs-usb-spindown "Pool ${pool} active (r=${read_ops:-0} w=${write_ops:-0} rb=${read_bytes:-0} wb=${write_bytes:-0}); skipping spindown."
        exit 0
      fi
    fi
  fi
fi

if [[ "${spindown_device_count}" -eq 0 ]]; then
  logger -t zfs-usb-spindown "No spindown devices configured; skipping."
  exit 0
fi

for dev in "${spindown_devices[@]}"; do
  if [[ -b "${dev}" ]]; then
    if ! hdparm -y "${dev}" >/dev/null 2>&1; then
      logger -t zfs-usb-spindown "hdparm failed for ${dev}"
    fi
  else
    logger -t zfs-usb-spindown "Device ${dev} not found; skipping."
  fi
done
