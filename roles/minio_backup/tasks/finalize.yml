---
- name: Capture backup size
  ansible.builtin.command:
    cmd: du -sb "{{ minio_backup_dir }}"
  register: minio_backup_size_cmd
  changed_when: false
  when: minio_backup_report_size | bool

- name: Build backup metadata structure
  ansible.builtin.set_fact:
    minio_backup_metadata:
      timestamp: "{{ minio_backup_timestamp }}"
      host: "{{ inventory_hostname }}"
      minio_version: "{{ minio_backup_minio_version_cmd.stdout | default('unknown') }}"
      mc_version: "{{ minio_backup_mc_version_cmd.stdout | default('unknown') }}"
      api_bind_host: "{{ minio_api_bind_host }}"
      api_port: "{{ minio_api_port }}"
      console_port: "{{ minio_console_port }}"
      tls_enabled: "{{ minio_tls_enable | bool }}"
      data_dirs: "{{ minio_backup_data_dirs_backed_up | default(minio_data_dirs) }}"
      metadata_exports:
        iam: "{{ minio_backup_export_iam | bool }}"
        bucket: "{{ minio_backup_export_bucket_metadata | bool }}"
      backup_options:
        rsync_delete: "{{ minio_backup_use_delete | bool }}"
        archive_format: "{{ minio_backup_archive_format }}"
        checksums: "{{ minio_backup_generate_checksums | bool }}"
      size_bytes: "{{ (minio_backup_size_cmd.stdout.split()[0] | int) if (minio_backup_size_cmd is defined and minio_backup_report_size) else omit }}"

- name: Write metadata file
  ansible.builtin.copy:
    dest: "{{ minio_backup_dir }}/metadata.yml"
    content: "{{ minio_backup_metadata | to_nice_yaml(indent=2) }}"
    owner: "{{ minio_backup_owner }}"
    group: "{{ minio_backup_group }}"
    mode: "{{ minio_backup_file_mode }}"

- name: Generate SHA256 manifest
  ansible.builtin.shell: |
    set -euo pipefail
    cd "{{ minio_backup_dir }}"
    find . -type f ! -name manifest.sha256 -print0 | sort -z | xargs -0 sha256sum > manifest.sha256
  args:
    executable: /bin/bash
  when: minio_backup_generate_checksums | bool

- name: Ensure manifest permissions
  ansible.builtin.file:
    path: "{{ minio_backup_dir }}/manifest.sha256"
    owner: "{{ minio_backup_owner }}"
    group: "{{ minio_backup_group }}"
    mode: "{{ minio_backup_file_mode }}"
  when: minio_backup_generate_checksums | bool

- name: Report backup snapshot details
  ansible.builtin.debug:
    msg: >-
      MinIO backup complete at {{ minio_backup_dir }} ({{ minio_backup_metadata.size_bytes | default('unknown') }} bytes).
