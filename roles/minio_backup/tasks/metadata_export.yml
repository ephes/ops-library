---
- name: Prepare metadata export workspace
  ansible.builtin.file:
    path: "{{ minio_backup_metadata_temp_dir }}"
    state: directory
    mode: "0700"

- name: Build mc helper facts for metadata export
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../minio_shared/tasks/mc_host_env.yml"
  vars:
    mc_helper_register_var: minio_backup_mc_helper
    mc_helper_alias: "{{ minio_mc_host_alias }}"
    mc_helper_username: "{{ minio_root_user }}"
    mc_helper_password: "{{ minio_root_password }}"
    mc_helper_host: "{{ minio_api_bind_host }}"
    mc_helper_port: "{{ minio_api_port }}"
    mc_helper_no_tls: "{{ minio_backup_mc_no_tls }}"
    mc_helper_insecure: "{{ minio_backup_mc_insecure }}"
    mc_helper_ca_cert_path: "{{ minio_backup_mc_ca_cert_path }}"

- name: Test mc connectivity
  ansible.builtin.command: >-
    {{ minio_mc_bin_path }}
    {{ minio_backup_mc_helper.extra_args }}
    admin info {{ minio_mc_host_alias }}
  environment: "{{ minio_backup_mc_helper.env_map }}"
  register: minio_backup_mc_test
  changed_when: false
  no_log: true

- name: Export IAM metadata
  when: minio_backup_export_iam | bool
  ansible.builtin.command: >-
    {{ minio_mc_bin_path }}
    {{ minio_backup_mc_helper.extra_args }}
    admin cluster iam export {{ minio_mc_host_alias }}
    --output {{ minio_backup_metadata_temp_dir }}/iam-metadata.zip
  environment: "{{ minio_backup_mc_helper.env_map }}"
  changed_when: true
  no_log: true

- name: Export bucket metadata
  when: minio_backup_export_bucket_metadata | bool
  ansible.builtin.command: >-
    {{ minio_mc_bin_path }}
    {{ minio_backup_mc_helper.extra_args }}
    admin cluster bucket export {{ minio_mc_host_alias }}
  args:
    chdir: "{{ minio_backup_metadata_temp_dir }}"
  environment: "{{ minio_backup_mc_helper.env_map }}"
  register: minio_backup_bucket_export
  changed_when: true
  no_log: true

- name: Discover bucket metadata archive
  ansible.builtin.find:
    paths: "{{ minio_backup_metadata_temp_dir }}"
    patterns:
      - "*bucket-metadata.zip"
      - "cluster-metadata.zip"
    recurse: false
    file_type: file
  register: minio_backup_bucket_find
  when: minio_backup_export_bucket_metadata | bool

- name: Fail if bucket metadata export missing
  ansible.builtin.fail:
    msg: "Bucket metadata export did not produce a ZIP file"
  when:
    - minio_backup_export_bucket_metadata | bool
    - minio_backup_bucket_find.matched | default(0) | int == 0

- name: Select bucket metadata filename
  ansible.builtin.set_fact:
    minio_backup_bucket_metadata_filename: "{{ minio_backup_bucket_find.files[0].path | basename }}"
  when: minio_backup_export_bucket_metadata | bool

- name: Copy IAM metadata into backup directory
  ansible.builtin.copy:
    src: "{{ minio_backup_metadata_temp_dir }}/iam-metadata.zip"
    dest: "{{ minio_backup_metadata_dir }}/iam-metadata.zip"
    remote_src: true
    mode: "{{ minio_backup_file_mode }}"
  when: minio_backup_export_iam | bool

- name: Copy bucket metadata into backup directory
  ansible.builtin.copy:
    src: "{{ minio_backup_metadata_temp_dir }}/{{ minio_backup_bucket_metadata_filename }}"
    dest: "{{ minio_backup_metadata_dir }}/bucket-metadata.zip"
    remote_src: true
    mode: "{{ minio_backup_file_mode }}"
  when: minio_backup_export_bucket_metadata | bool

- name: Ensure IAM metadata extraction directory exists
  ansible.builtin.file:
    path: "{{ minio_backup_metadata_dir }}/iam-metadata"
    state: directory
    mode: "{{ minio_backup_dir_mode }}"
  when: minio_backup_export_iam | bool

- name: Extract IAM metadata for inspection
  ansible.builtin.unarchive:
    src: "{{ minio_backup_metadata_dir }}/iam-metadata.zip"
    dest: "{{ minio_backup_metadata_dir }}/iam-metadata"
    remote_src: true
  when: minio_backup_export_iam | bool

- name: Ensure bucket metadata extraction directory exists
  ansible.builtin.file:
    path: "{{ minio_backup_metadata_dir }}/bucket-metadata"
    state: directory
    mode: "{{ minio_backup_dir_mode }}"
  when: minio_backup_export_bucket_metadata | bool

- name: Extract bucket metadata for inspection
  ansible.builtin.unarchive:
    src: "{{ minio_backup_metadata_dir }}/bucket-metadata.zip"
    dest: "{{ minio_backup_metadata_dir }}/bucket-metadata"
    remote_src: true
  when: minio_backup_export_bucket_metadata | bool

- name: Clean up temporary metadata directory
  ansible.builtin.file:
    path: "{{ minio_backup_metadata_temp_dir }}"
    state: absent
