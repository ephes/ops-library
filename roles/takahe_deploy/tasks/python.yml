---
- name: Ensure requirements.txt exists
  ansible.builtin.stat:
    path: "{{ takahe_site_path }}/requirements.txt"
  register: takahe_requirements_stat

- name: Fail when requirements.txt is missing
  ansible.builtin.fail:
    msg: "requirements.txt not found in {{ takahe_site_path }}"
  when: not takahe_requirements_stat.stat.exists

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: "python3 -m venv {{ takahe_venv_path }}"
  args:
    creates: "{{ takahe_venv_path }}/bin/python"
  become: true
  become_user: "{{ takahe_user }}"

- name: Upgrade pip inside virtualenv
  ansible.builtin.pip:
    name: pip
    state: latest
    virtualenv: "{{ takahe_venv_path }}"
  become: true
  become_user: "{{ takahe_user }}"
  when: takahe_pip_upgrade | bool

- name: Install Takahe requirements
  ansible.builtin.pip:
    requirements: "{{ takahe_site_path }}/requirements.txt"
    virtualenv: "{{ takahe_venv_path }}"
  become: true
  become_user: "{{ takahe_user }}"
