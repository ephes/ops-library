---
- name: Install git when missing
  ansible.builtin.package:
    name: git
    state: present

- name: Check for existing git repository
  ansible.builtin.stat:
    path: "{{ takahe_git_dest }}/.git"
  register: takahe_git_dir

- name: Check destination directory
  ansible.builtin.stat:
    path: "{{ takahe_git_dest }}"
  register: takahe_git_dest_dir

- name: Handle existing non-git directory
  block:
    - name: Backup existing directory
      ansible.builtin.command:
        cmd: "mv {{ takahe_git_dest }} {{ takahe_git_dest }}.backup.{{ ansible_date_time.epoch }}"
      when: takahe_git_dest_dir.stat.exists

    - name: Ensure parent directory exists
      ansible.builtin.file:
        path: "{{ takahe_git_dest | dirname }}"
        state: directory
        owner: "{{ takahe_user }}"
        group: "{{ takahe_group }}"
        mode: "0755"
  when: not takahe_git_dir.stat.exists

- name: Clone or update Takahe repository
  ansible.builtin.git:
    repo: "{{ takahe_git_repo }}"
    dest: "{{ takahe_git_dest }}"
    version: "{{ takahe_git_ref }}"
    force: true
    accept_hostkey: true
  become: true
  become_user: "{{ takahe_user }}"
  register: takahe_git_result

- name: Ensure correct ownership of repository
  ansible.builtin.file:
    path: "{{ takahe_git_dest }}"
    owner: "{{ takahe_user }}"
    group: "{{ takahe_group }}"
    recurse: true
  when: takahe_git_result.changed

- name: Clean Python bytecode files after git update
  ansible.builtin.command:
    cmd: "find {{ takahe_git_dest }} -type f -name '*.pyc' -delete"
  become: true
  become_user: "{{ takahe_user }}"
  when: takahe_git_result.changed
  changed_when: false

- name: Clean Python cache directories after git update
  ansible.builtin.command:
    cmd: "find {{ takahe_git_dest }} -type d -name '__pycache__' -exec rm -rf {} +"
  become: true
  become_user: "{{ takahe_user }}"
  when: takahe_git_result.changed
  changed_when: false
  failed_when: false
