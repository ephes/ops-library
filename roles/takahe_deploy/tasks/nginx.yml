---
- name: Read resolver from /etc/resolv.conf
  ansible.builtin.slurp:
    src: /etc/resolv.conf
  register: takahe_resolv_conf
  when: takahe_nginx_resolver | length == 0

- name: Extract resolvers from /etc/resolv.conf
  ansible.builtin.set_fact:
    takahe_nginx_resolver_candidates: >-
      {{ (takahe_resolv_conf.content | b64decode).splitlines()
         | select('match', '^\\s*nameserver\\s+')
         | map('regex_replace', '^\\s*nameserver\\s+([^\\s]+).*', '\\1')
         | reject('equalto', '127.0.0.53')
         | list }}
  when: takahe_nginx_resolver | length == 0

- name: Check systemd-resolved resolver file
  ansible.builtin.stat:
    path: /run/systemd/resolve/resolv.conf
  register: takahe_systemd_resolv_conf_stat
  when:
    - takahe_nginx_resolver | length == 0
    - takahe_nginx_resolver_candidates | default([]) | length == 0

- name: Read systemd-resolved resolver file
  ansible.builtin.slurp:
    src: /run/systemd/resolve/resolv.conf
  register: takahe_systemd_resolv_conf
  when:
    - takahe_nginx_resolver | length == 0
    - takahe_nginx_resolver_candidates | default([]) | length == 0
    - takahe_systemd_resolv_conf_stat is defined
    - takahe_systemd_resolv_conf_stat.stat.exists

- name: Extract resolvers from systemd-resolved file
  ansible.builtin.set_fact:
    takahe_nginx_resolver_candidates: >-
      {{ (takahe_systemd_resolv_conf.content | b64decode).splitlines()
         | select('match', '^\\s*nameserver\\s+')
         | map('regex_replace', '^\\s*nameserver\\s+([^\\s]+).*', '\\1')
         | reject('equalto', '127.0.0.53')
         | list }}
  when:
    - takahe_nginx_resolver | length == 0
    - takahe_nginx_resolver_candidates | default([]) | length == 0
    - takahe_systemd_resolv_conf is defined
    - takahe_systemd_resolv_conf.content is defined

- name: Set nginx resolver from resolv.conf
  ansible.builtin.set_fact:
    takahe_nginx_resolver: >-
      {{ takahe_nginx_resolver_candidates
         | join(' ')
         | default(takahe_nginx_resolver_fallback, true) }}
  when: takahe_nginx_resolver | length == 0

- name: Render Takahe nginx config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ takahe_nginx_config_path }}"
    owner: root
    group: root
    mode: "0644"
  notify:
    - restart takahe-nginx

- name: Render Takahe nginx systemd unit
  ansible.builtin.template:
    src: nginx.service.j2
    dest: "{{ takahe_nginx_unit_path }}"
    owner: root
    group: root
    mode: "0644"
  notify:
    - reload systemd
    - restart takahe-nginx

- name: Enable and start Takahe nginx
  ansible.builtin.systemd:
    name: "{{ takahe_nginx_service_name }}"
    enabled: true
    state: started
    daemon_reload: true
