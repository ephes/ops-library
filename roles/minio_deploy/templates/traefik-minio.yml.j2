# Traefik configuration for MinIO
# Managed by Ansible - do not edit manually
# Uses separate subdomains for API (S3) and Console (Web UI)
# Implements dual router pattern on Console: no auth on LAN/Tailscale, basic auth on public

http:
  routers:
    # ===== API ENDPOINT (S3 operations) =====
    # No authentication - S3 credentials in requests
    minio-api-secure:
      rule: "Host(`{{ minio_traefik_api_host }}`)"
      entryPoints:
        - web-secure
      middlewares:
        - minio-api-headers
      service: minio-api
{% if minio_traefik_cert_resolver | default('') | length > 0 %}
      tls:
        certResolver: {{ minio_traefik_cert_resolver }}
{% else %}
      tls: {}
{% endif %}

    # HTTP redirect for API
    minio-api-http:
      rule: "Host(`{{ minio_traefik_api_host }}`)"
      entryPoints:
        - web
      middlewares:
        - minio-https-redirect
      service: minio-api

    # ===== CONSOLE ENDPOINT (Web UI) on main domain (at root) =====
{% if minio_console_basic_auth_enabled %}
    # INTERNAL router (LAN + Tailscale) - NO auth, higher priority
    minio-console-int:
      rule: "Host(`{{ minio_traefik_host }}`) && ({% for range in minio_internal_ip_ranges %}ClientIP(`{{ range }}`){{ ' || ' if not loop.last else '' }}{% endfor %})"
      entryPoints:
        - web-secure
      priority: 120
      middlewares:
        - minio-console-headers
      service: minio-console
{% if minio_traefik_cert_resolver | default('') | length > 0 %}
      tls:
        certResolver: {{ minio_traefik_cert_resolver }}
{% else %}
      tls: {}
{% endif %}

    # EXTERNAL router (Public) - WITH auth, lower priority
    minio-console-ext:
      rule: "Host(`{{ minio_traefik_host }}`)"
      entryPoints:
        - web-secure
      priority: 100
      middlewares:
        - minio-console-auth
        - minio-console-headers
      service: minio-console
{% if minio_traefik_cert_resolver | default('') | length > 0 %}
      tls:
        certResolver: {{ minio_traefik_cert_resolver }}
{% else %}
      tls: {}
{% endif %}
{% else %}
    # Single router without authentication
    minio-console-secure:
      rule: "Host(`{{ minio_traefik_host }}`)"
      entryPoints:
        - web-secure
      middlewares:
        - minio-console-headers
      service: minio-console
{% if minio_traefik_cert_resolver | default('') | length > 0 %}
      tls:
        certResolver: {{ minio_traefik_cert_resolver }}
{% else %}
      tls: {}
{% endif %}
{% endif %}

    # HTTP redirect for Console
    minio-console-http:
      rule: "Host(`{{ minio_traefik_host }}`)"
      entryPoints:
        - web
      middlewares:
        - minio-https-redirect
      service: minio-console

  middlewares:
    # HTTPS redirect
    minio-https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

{% if minio_console_basic_auth_enabled %}
    # Basic auth for Console (external access)
    minio-console-auth:
      basicAuth:
        users:
          - "{{ minio_console_basic_auth_user }}:{{ minio_console_basic_auth_password_hash }}"
        removeHeader: true
{% endif %}

    # Security headers for API
    minio-api-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 15552000
        customRequestHeaders:
          X-Forwarded-Proto: https

    # Security headers for Console
    minio-console-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 15552000
        customFrameOptionsValue: SAMEORIGIN
        customRequestHeaders:
          X-Forwarded-Proto: https

  services:
    # S3 API service
    minio-api:
      loadBalancer:
        servers:
          - url: "http://{{ minio_bind_host }}:{{ minio_api_port }}"

    # Web Console service
    minio-console:
      loadBalancer:
        servers:
          - url: "http://{{ minio_bind_host }}:{{ minio_console_port }}"
