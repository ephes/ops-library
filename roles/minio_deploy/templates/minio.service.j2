[Unit]
Description=MinIO Object Storage
Documentation=https://docs.min.io
Wants=network-online.target
After=network-online.target
AssertFileIsExecutable={{ minio_bin_path }}

[Service]
WorkingDirectory={{ minio_home }}

User={{ minio_user }}
Group={{ minio_group }}

# Environment
EnvironmentFile={{ minio_env_file }}

# Validation and startup
ExecStartPre=/bin/bash -c 'if [ -z "${MINIO_VOLUMES}" ]; then echo "ERROR: MINIO_VOLUMES not set in {{ minio_env_file }}"; exit 1; fi'
ExecStart={{ minio_bin_path }} server $MINIO_OPTS $MINIO_VOLUMES

# Restart policy
Restart={{ minio_systemd_restart }}
RestartSec=10

# Resource limits
LimitNOFILE={{ minio_systemd_limit_nofile }}
TasksMax={{ minio_systemd_tasks_max }}
{% if minio_systemd_memory_max %}
MemoryMax={{ minio_systemd_memory_max }}
{% endif %}

# Security hardening
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=full
ProtectHome=read-only
CapabilityBoundingSet=
RestrictAddressFamilies=AF_INET AF_INET6 AF_NETLINK
LockPersonality=yes
ProtectControlGroups=yes
ProtectKernelModules=yes
ProtectKernelTunables=yes
RestrictNamespaces=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes
SystemCallArchitectures=native

# Timeout management
TimeoutStopSec=infinity
SendSIGKILL=no

[Install]
WantedBy=multi-user.target
