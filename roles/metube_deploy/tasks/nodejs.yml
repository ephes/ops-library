---
- name: Check current Node.js version
  ansible.builtin.command: node --version
  register: metube_node_version_check
  failed_when: false
  changed_when: false

- name: Parse Node.js major version
  ansible.builtin.set_fact:
    metube_node_current_major: "{{ metube_node_version_check.stdout | default('v0') | regex_replace('^v([0-9]+).*', '\\1') | int }}"
  when: metube_node_version_check.rc == 0

- name: Determine if Node.js install/upgrade is needed
  ansible.builtin.set_fact:
    metube_node_needs_install: "{{ metube_node_version_check.rc != 0 or (metube_node_current_major | int) != (metube_nodejs_version | int) }}"

- name: Install Node.js from NodeSource repository
  when: metube_node_needs_install | bool
  block:
    - name: Install prerequisites for NodeSource setup
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Ensure keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Download NodeSource GPG key
      ansible.builtin.shell: |
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
      args:
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Add NodeSource repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ metube_nodejs_version }}.x nodistro main"
        filename: nodesource-metube
        state: present

    - name: Install Node.js {{ metube_nodejs_version }}.x
      ansible.builtin.apt:
        name: "nodejs={{ metube_nodejs_version }}.*"
        state: present
        allow_downgrade: true
        update_cache: true
