---
- name: Ensure Traefik dynamic config directory exists
  ansible.builtin.file:
    path: "{{ metube_traefik_config_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Build basic auth hash from password
  ansible.builtin.command:
    argv:
      - htpasswd
      - -nbB
      - "{{ metube_basic_auth_user }}"
      - "{{ metube_basic_auth_password }}"
  register: metube_basic_auth_htpasswd
  changed_when: false
  no_log: true
  when:
    - metube_basic_auth_enabled | bool
    - metube_basic_auth_password_hash | length == 0

- name: Set MeTube basic auth hash fact
  ansible.builtin.set_fact:
    metube_basic_auth_password_hash: "{{ metube_basic_auth_htpasswd.stdout.split(':', 1)[1] if metube_basic_auth_htpasswd.stdout is defined else metube_basic_auth_password_hash }}"
  no_log: true
  when: metube_basic_auth_enabled | bool

- name: Render Traefik configuration for MeTube
  ansible.builtin.template:
    src: metube-traefik.yml.j2
    dest: "{{ metube_traefik_config_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: reload traefik
