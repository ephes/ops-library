[Unit]
Description=Collect backup metrics and write to JSON file
After=network.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c '/usr/bin/python3 {{ backup_metrics_endpoint_exporter_path }} > {{ backup_metrics_endpoint_json_path }}.tmp && mv {{ backup_metrics_endpoint_json_path }}.tmp {{ backup_metrics_endpoint_json_path }}'

# Run as root to access systemd and ZFS metadata.
User=root
Group=root

# Minimal hardening that keeps required root-level reads working.
ProtectHome=true
ProtectKernelModules=true
ProtectKernelTunables=true
PrivateTmp=true

# Ensure directory exists and has correct permissions
ExecStartPre=/bin/mkdir -p {{ backup_metrics_endpoint_data_dir }}
ExecStartPre=/bin/chown root:{{ backup_metrics_endpoint_group }} {{ backup_metrics_endpoint_data_dir }}
ExecStartPre=/bin/chmod 0750 {{ backup_metrics_endpoint_data_dir }}

# After writing, ensure the metrics user can read the file
ExecStartPost=/bin/chown root:{{ backup_metrics_endpoint_group }} {{ backup_metrics_endpoint_json_path }}
ExecStartPost=/bin/chmod 0640 {{ backup_metrics_endpoint_json_path }}
