---
- name: Wait for Navidrome port to be open
  ansible.builtin.wait_for:
    host: "{{ navidrome_listen_address }}"
    port: "{{ navidrome_port }}"
    timeout: "{{ navidrome_healthcheck_timeout }}"
    state: started

- name: Perform Navidrome HTTP health check
  ansible.builtin.uri:
    url: "{{ navidrome_healthcheck_url }}"
    status_code: [200, 302]
    return_content: false
    timeout: "{{ navidrome_healthcheck_timeout }}"
  register: navidrome_healthcheck_result
  retries: "{{ navidrome_healthcheck_retries }}"
  delay: 2
  until: navidrome_healthcheck_result.status in [200, 302]
