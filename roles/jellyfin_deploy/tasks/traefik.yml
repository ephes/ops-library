---
- name: Ensure Traefik dynamic config directory exists
  ansible.builtin.file:
    path: "{{ jellyfin_traefik_config_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Build basic auth hash from password
  ansible.builtin.command:
    argv:
      - htpasswd
      - -nbB
      - "{{ jellyfin_basic_auth_user }}"
      - "{{ jellyfin_basic_auth_password }}"
  register: jellyfin_basic_auth_htpasswd
  changed_when: false
  no_log: true
  when:
    - jellyfin_basic_auth_enabled | bool
    - jellyfin_basic_auth_password_hash | length == 0

- name: Set Jellyfin basic auth hash fact
  ansible.builtin.set_fact:
    jellyfin_basic_auth_password_hash: "{{ jellyfin_basic_auth_htpasswd.stdout.split(':', 1)[1] if jellyfin_basic_auth_htpasswd.stdout is defined else jellyfin_basic_auth_password_hash }}"
  no_log: true
  when: jellyfin_basic_auth_enabled | bool

- name: Render Traefik configuration for Jellyfin
  ansible.builtin.template:
    src: jellyfin-traefik.yml.j2
    dest: "{{ jellyfin_traefik_config_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: reload traefik
