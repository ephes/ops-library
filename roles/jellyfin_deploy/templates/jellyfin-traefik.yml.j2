# Managed by Ansible - Traefik configuration for Jellyfin

http:
  routers:
{% if jellyfin_basic_auth_enabled %}
    jellyfin-int:
      rule: "Host(`{{ jellyfin_traefik_host }}`) && ({% for range in jellyfin_internal_ip_ranges %}ClientIP(`{{ range }}`){{ ' || ' if not loop.last else '' }}{% endfor %})"
      entryPoints:
{% for ep in jellyfin_traefik_entrypoints %}
        - {{ ep }}
{% endfor %}
      priority: 120
      middlewares:
        - jellyfin-headers
        - jellyfin-gzip
{% for middleware in jellyfin_traefik_middlewares %}
        - {{ middleware }}
{% endfor %}
      service: jellyfin
      tls:
{% if jellyfin_traefik_cert_resolver | default('') | length > 0 %}
        certResolver: {{ jellyfin_traefik_cert_resolver }}
{% endif %}

    jellyfin-ext:
      rule: "Host(`{{ jellyfin_traefik_host }}`)"
      entryPoints:
{% for ep in jellyfin_traefik_entrypoints %}
        - {{ ep }}
{% endfor %}
      priority: 100
      middlewares:
        - jellyfin-auth
        - jellyfin-headers
        - jellyfin-gzip
{% for middleware in jellyfin_traefik_middlewares %}
        - {{ middleware }}
{% endfor %}
      service: jellyfin
      tls:
{% if jellyfin_traefik_cert_resolver | default('') | length > 0 %}
        certResolver: {{ jellyfin_traefik_cert_resolver }}
{% endif %}
{% else %}
    jellyfin-secure:
      rule: "Host(`{{ jellyfin_traefik_host }}`)"
      entryPoints:
{% for ep in jellyfin_traefik_entrypoints %}
        - {{ ep }}
{% endfor %}
      middlewares:
        - jellyfin-headers
        - jellyfin-gzip
{% for middleware in jellyfin_traefik_middlewares %}
        - {{ middleware }}
{% endfor %}
      service: jellyfin
      tls:
{% if jellyfin_traefik_cert_resolver | default('') | length > 0 %}
        certResolver: {{ jellyfin_traefik_cert_resolver }}
{% endif %}
{% endif %}

    jellyfin-http:
      rule: "Host(`{{ jellyfin_traefik_host }}`)"
      entryPoints:
        - web
      middlewares:
        - jellyfin-redirect
      service: jellyfin

  middlewares:
{% if jellyfin_basic_auth_enabled %}
    jellyfin-auth:
      basicAuth:
        users:
          - "{{ jellyfin_basic_auth_user }}:{{ jellyfin_basic_auth_password_hash }}"
        removeHeader: {{ jellyfin_basic_auth_remove_header | bool }}
{% endif %}

    jellyfin-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 15552000
        customFrameOptionsValue: SAMEORIGIN
        customRequestHeaders:
          X-Forwarded-Proto: https
          X-Forwarded-Host: "{{ jellyfin_traefik_host }}"

    jellyfin-gzip:
      compress: {}

    jellyfin-redirect:
      redirectScheme:
        scheme: https
        permanent: true

  services:
    jellyfin:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:{{ jellyfin_http_port }}"
