---
# Setup Python environment for Homelab

- name: Ensure uv usage is enabled
  ansible.builtin.assert:
    that:
      - homelab_use_uv | bool
    fail_msg: "homelab_use_uv must be true; homelab_deploy requires uv for venv management."

- name: Ensure uv binary is installed
  ansible.builtin.import_role:
    name: uv_install
  vars:
    uv_install_dir: "{{ homelab_uv_path | dirname }}"

- name: Test if venv Python is usable
  command: "{{ homelab_venv_path }}/bin/python --version"
  register: venv_python_test
  become_user: "{{ homelab_user }}"
  failed_when: false
  changed_when: false

- name: Extract current venv Python version
  set_fact:
    venv_python_current: "{{ venv_python_test.stdout | regex_replace('^Python (\\d+\\.\\d+).*$', '\\1') }}"
  when: venv_python_test.rc == 0

- name: Remove broken venv if Python is not usable
  file:
    path: "{{ homelab_venv_path }}"
    state: absent
  when: venv_python_test.rc != 0

- name: Remove venv if Python version doesn't match
  file:
    path: "{{ homelab_venv_path }}"
    state: absent
  when:
    - venv_python_test.rc == 0
    - venv_python_current is defined
    - venv_python_current != homelab_python_version

- name: Create virtual environment using uv
  command: "{{ homelab_uv_path }} venv --python {{ homelab_python_version }} {{ homelab_venv_path }}"
  args:
    chdir: "{{ homelab_site_path }}"
    creates: "{{ homelab_venv_path }}/bin/python"
  become_user: "{{ homelab_user }}"

- name: Check if venv symlink exists
  stat:
    path: "{{ homelab_site_path }}/venv"
  register: venv_link

- name: Create venv symlink to .venv
  file:
    src: .venv
    dest: "{{ homelab_site_path }}/venv"
    state: link
    owner: "{{ homelab_user }}"
    group: "{{ homelab_group }}"
  when: not venv_link.stat.exists

- name: Install dependencies with uv sync
  command: "{{ homelab_uv_path }} sync --frozen"
  args:
    chdir: "{{ homelab_site_path }}"
  environment:
    VIRTUAL_ENV: "{{ homelab_venv_path }}"
  become_user: "{{ homelab_user }}"
  register: uv_sync_result
  changed_when: "'Installed' in uv_sync_result.stdout or 'Updated' in uv_sync_result.stdout"
