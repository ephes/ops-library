---
# Setup Python environment for Wagtail

- name: Ensure Python runtime is installed
  ansible.builtin.package:
    name:
      - python3
      - python3-venv
      - python3-pip
    state: present

- name: Check uv binary path
  ansible.builtin.stat:
    path: "{{ wagtail_uv_path }}"
  register: wagtail_uv_stat

- name: Fail if uv is not installed
  ansible.builtin.fail:
    msg: "uv is required but not installed at {{ wagtail_uv_path }}"
  when: not wagtail_uv_stat.stat.exists

- name: Check for requested Python version
  ansible.builtin.command:
    cmd: "{{ wagtail_uv_path }} python find {{ wagtail_python_version }}"
  register: _wagtail_uv_python_find
  become_user: "{{ wagtail_user }}"
  changed_when: false
  failed_when: false
  when: wagtail_python_version | length > 0

- name: Install requested Python version via uv
  ansible.builtin.command:
    cmd: "{{ wagtail_uv_path }} python install {{ wagtail_python_version }}"
  become_user: "{{ wagtail_user }}"
  when:
    - wagtail_python_version | length > 0
    - _wagtail_uv_python_find.rc != 0

- name: Determine Python executable path
  ansible.builtin.command:
    cmd: "{{ wagtail_uv_path }} python find {{ wagtail_python_version }}"
  register: _wagtail_python_exec_path
  become_user: "{{ wagtail_user }}"
  changed_when: false
  when: wagtail_python_version | length > 0

- name: Set Python executable fact
  ansible.builtin.set_fact:
    _wagtail_python_executable: "{{ _wagtail_python_exec_path.stdout | trim }}"
  when: wagtail_python_version | length > 0

- name: Set Python executable fact (fallback)
  ansible.builtin.set_fact:
    _wagtail_python_executable: "{{ wagtail_global_python }}"
  when: wagtail_python_version | length == 0

- name: Check existing virtualenv Python binary
  ansible.builtin.stat:
    path: "{{ wagtail_venv_path }}/bin/python"
  register: _wagtail_venv_python_stat

- name: Detect current virtualenv Python version
  ansible.builtin.command:
    cmd: "{{ wagtail_venv_path }}/bin/python --version"
  register: _wagtail_current_python_version
  changed_when: false
  failed_when: false
  when: _wagtail_venv_python_stat.stat.exists

- name: Set Python version mismatch fact
  ansible.builtin.set_fact:
    _wagtail_python_mismatch: >-
      {{ (_wagtail_current_python_version.stdout | default('')).split()[1] != wagtail_python_version }}
  when:
    - _wagtail_venv_python_stat.stat.exists
    - _wagtail_current_python_version.stdout is defined
    - wagtail_python_version | length > 0

- name: Remove broken virtualenv if Python is not usable
  ansible.builtin.file:
    path: "{{ wagtail_venv_path }}"
    state: absent
  when:
    - _wagtail_venv_python_stat.stat.exists
    - _wagtail_current_python_version.rc is defined
    - _wagtail_current_python_version.rc != 0

- name: Remove virtualenv if Python version changed
  ansible.builtin.file:
    path: "{{ wagtail_venv_path }}"
    state: absent
  when:
    - _wagtail_venv_python_stat.stat.exists
    - _wagtail_python_mismatch | default(false)

- name: Create virtual environment using uv
  ansible.builtin.command: "{{ wagtail_uv_path }} venv --python {{ _wagtail_python_executable }} {{ wagtail_venv_path }}"
  args:
    creates: "{{ wagtail_venv_path }}/bin/python"
  become: true
  become_user: "{{ wagtail_user }}"

- name: Create venv symlink
  ansible.builtin.file:
    src: "{{ wagtail_venv_path }}"
    dest: "{{ wagtail_site_path }}/venv"
    state: link
    owner: "{{ wagtail_user }}"
    group: "{{ wagtail_group }}"
    force: true

- name: Install dependencies with uv
  ansible.builtin.command: "{{ wagtail_uv_path }} sync --frozen"
  args:
    chdir: "{{ wagtail_site_path }}"
  environment:
    VIRTUAL_ENV: "{{ wagtail_venv_path }}"
    UV_PROJECT_ENVIRONMENT: "{{ wagtail_venv_path }}"
  become: true
  become_user: "{{ wagtail_user }}"
  register: wagtail_uv_sync
  changed_when: "'Installed' in wagtail_uv_sync.stdout or 'Updated' in wagtail_uv_sync.stdout"
