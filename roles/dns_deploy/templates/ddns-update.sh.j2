#!/usr/bin/env bash
set -euo pipefail

# DDNS Update Script - Generated by Ansible
# Updates DNS records via Gandi LiveDNS API

# Configuration
ZONE="{{ dns_ddns_domain }}"
NAME="{{ dns_ddns_subdomain }}"
KEY="${GANDI_API_TOKEN}"  # From environment
LOG_FILE="{{ dns_ddns_log_dir }}/ddns-update.log"
UPDATE_WILDCARD="{{ dns_ddns_update_wildcard | lower }}"
IPV4_ENABLED="{{ dns_ddns_ipv4_enabled | lower }}"
IPV6_ENABLED="{{ dns_ddns_ipv6_enabled | lower }}"

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Get current public IPs
log "Starting DNS update check for ${NAME}.${ZONE}..."

IP4=""
IP6=""

if [ "$IPV4_ENABLED" = "true" ]; then
    IP4=$(curl -s --connect-timeout 10 https://ipv4.icanhazip.com || echo "")
    log "Current IPv4: ${IP4:-not found}"
fi

if [ "$IPV6_ENABLED" = "true" ]; then
    IP6=$(curl -s --connect-timeout 10 https://ipv6.icanhazip.com || echo "")
    log "Current IPv6: ${IP6:-not found}"
fi

# Check if we got at least one IP
if [ -z "${IP4:-}" ] && [ -z "${IP6:-}" ]; then
    log "ERROR: Could not determine any public IP address"
    exit 1
fi

# Gandi API endpoint base
API_BASE="https://api.gandi.net/v5/livedns/domains/$ZONE/records"

# Track if any updates were made
UPDATED=false

# Function to update DNS record
update_record() {
    local subdomain=$1
    local record_type=$2
    local ip_value=$3

    log "Updating $record_type record for ${subdomain}.${ZONE}..."
    RESPONSE=$(curl -sX PUT "$API_BASE/$subdomain/$record_type" \
        -H "Authorization: Bearer $KEY" \
        -H "Content-Type: application/json" \
        -d "{\"rrset_ttl\":{{ dns_ddns_ttl }},\"rrset_values\":[\"$ip_value\"]}" \
        -w "\nHTTP_CODE:%{http_code}")

    HTTP_CODE=$(echo "$RESPONSE" | grep -oP 'HTTP_CODE:\K\d+' || echo "000")
    if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
        log "$record_type record for ${subdomain}.${ZONE} updated successfully to $ip_value"
        UPDATED=true
    else
        log "ERROR: Failed to update $record_type record for ${subdomain}.${ZONE}. HTTP code: $HTTP_CODE"
        echo "$RESPONSE" | grep -v "HTTP_CODE:" >> "$LOG_FILE"
    fi
}

# Build list of subdomains to update
SUBDOMAINS=("$NAME")
if [ "$UPDATE_WILDCARD" = "true" ]; then
    SUBDOMAINS+=("*.$NAME")
fi

# Update records
for SUBDOMAIN in "${SUBDOMAINS[@]}"; do
    # Update IPv4 record
    if [ -n "${IP4:-}" ]; then
        update_record "$SUBDOMAIN" "A" "$IP4"
    fi

    # Update IPv6 record (if available)
    if [ -n "${IP6:-}" ]; then
        update_record "$SUBDOMAIN" "AAAA" "$IP6"
    fi
done

if [ "$UPDATED" = true ]; then
    log "DNS update completed successfully"
else
    log "No DNS records were updated"
fi

# Rotate log if it's getting too large
LOG_SIZE_LIMIT=$(( {{ dns_ddns_log_max_size_mb }} * 1048576 ))
if [ -f "$LOG_FILE" ]; then
    LOG_SIZE=$(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null || echo "0")
    if [ "$LOG_SIZE" -gt "$LOG_SIZE_LIMIT" ]; then
        mv "$LOG_FILE" "${LOG_FILE}.old"
        log "Log rotated due to size"
    fi
fi
