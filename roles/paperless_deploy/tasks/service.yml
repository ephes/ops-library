---
- name: Create Paperless temp directory
  ansible.builtin.file:
    path: "{{ paperless_temp_dir }}"
    state: directory
    owner: "{{ paperless_username }}"
    group: "{{ paperless_group }}"
    mode: "0755"
  become: true
  when: paperless_manage_tmpdir

- name: Enable and start Paperless services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
    daemon_reload: true
  loop: "{{ paperless_service_units }}"
  become: true

- name: Wait for Paperless services to become active
  ansible.builtin.command: "systemctl is-active {{ item }}"
  register: paperless_service_status
  changed_when: false
  failed_when: paperless_service_status.stdout.strip() != "active"
  retries: 5
  delay: 3
  loop: "{{ paperless_service_units }}"
  become: true
  until: paperless_service_status.stdout.strip() == "active"

- name: Verify Paperless HTTP health endpoint
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ paperless_app_port }}/api/"
    status_code: 200
    timeout: 10
  register: paperless_health_check
  retries: 10
  delay: 6
  until: paperless_health_check.status == 200
  changed_when: false
