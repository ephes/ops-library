---
# Mail skill deployment:
# - IMAP read-only commands (phase-1)
# - optional SMTP send command (phase-2)
# Included from main.yml when openclaw_imap_enabled is true.

- name: imap | Initialize resolved account map
  ansible.builtin.set_fact:
    _openclaw_imap_accounts_resolved: {}
  no_log: true

- name: imap | Normalize account credentials
  ansible.builtin.set_fact:
    _openclaw_imap_accounts_resolved: >-
      {{
        _openclaw_imap_accounts_resolved
        | combine(
            {
              item.key: {
                "username": item.value.username,
                "password": item.value.password,
                "mailbox": (
                  item.value.mailbox | default(openclaw_imap_default_mailbox)
                )
              }
            },
            recursive=True
          )
      }}
  loop: "{{ openclaw_imap_account_map | dict2items }}"
  no_log: true

- name: imap | Validate resolved account credentials
  ansible.builtin.assert:
    that:
      - item.value.username | string | trim | length > 0
      - item.value.password | string | trim | length > 0
      - item.value.mailbox | string | trim | length > 0
    fail_msg: >-
      IMAP account {{ item.key }} did not resolve to non-empty username/password/mailbox.
      Check openclaw_imap_account_map.
  loop: "{{ _openclaw_imap_accounts_resolved | dict2items }}"
  no_log: true

- name: imap | Build credentials payload
  ansible.builtin.set_fact:
    _openclaw_imap_credentials_payload:
      default_account: "{{ openclaw_imap_default_account }}"
      accounts: "{{ _openclaw_imap_accounts_resolved }}"
  no_log: true

- name: imap | Render account credentials file
  ansible.builtin.copy:
    content: "{{ _openclaw_imap_credentials_payload | to_nice_json }}\n"
    dest: "{{ openclaw_imap_credentials_path }}"
    owner: "1000"
    group: "1000"
    mode: "0600"
  no_log: true
  notify: restart openclaw

- name: imap | SMTP initialize resolved account map
  ansible.builtin.set_fact:
    _openclaw_smtp_accounts_resolved: {}
  no_log: true
  when: openclaw_smtp_enabled | bool

- name: imap | SMTP normalize account credentials
  ansible.builtin.set_fact:
    _openclaw_smtp_accounts_resolved: >-
      {{
        _openclaw_smtp_accounts_resolved
        | combine(
            {
              item.key: {
                "username": item.value.username,
                "password": item.value.password,
                "from_address": item.value.from_address,
                "from_name": item.value.from_name | default(''),
                "reply_to": item.value.reply_to | default('')
              }
            },
            recursive=True
          )
      }}
  loop: "{{ openclaw_smtp_account_map | dict2items }}"
  no_log: true
  when: openclaw_smtp_enabled | bool

- name: imap | SMTP validate resolved account credentials
  ansible.builtin.assert:
    that:
      - item.value.username | string | trim | length > 0
      - item.value.password | string | trim | length > 0
      - item.value.from_address | string | trim | length > 0
    fail_msg: >-
      SMTP account {{ item.key }} did not resolve to non-empty username/password/from_address.
      Check openclaw_smtp_account_map.
  loop: "{{ _openclaw_smtp_accounts_resolved | dict2items }}"
  no_log: true
  when: openclaw_smtp_enabled | bool

- name: imap | SMTP build credentials payload
  ansible.builtin.set_fact:
    _openclaw_smtp_credentials_payload:
      default_account: "{{ openclaw_smtp_default_account }}"
      accounts: "{{ _openclaw_smtp_accounts_resolved }}"
  no_log: true
  when: openclaw_smtp_enabled | bool

- name: imap | SMTP render account credentials file
  ansible.builtin.copy:
    content: "{{ _openclaw_smtp_credentials_payload | to_nice_json }}\n"
    dest: "{{ openclaw_smtp_credentials_path }}"
    owner: "1000"
    group: "1000"
    mode: "0600"
  no_log: true
  notify: restart openclaw
  when: openclaw_smtp_enabled | bool

- name: imap | Deploy mail-imap skill manifest
  ansible.builtin.template:
    src: mail-imap-skill.json.j2
    dest: "{{ openclaw_imap_skills_dir }}/{{ openclaw_imap_skill_name }}/skill.json"
    owner: "1000"
    group: "1000"
    mode: "0640"
  notify: restart openclaw

- name: imap | Deploy mail-imap skill handler
  ansible.builtin.template:
    src: mail-imap-handler.py.j2
    dest: "{{ openclaw_imap_skills_dir }}/{{ openclaw_imap_skill_name }}/handler.py"
    owner: "1000"
    group: "1000"
    mode: "0750"
  notify: restart openclaw

- name: imap | Deploy /mail command SKILL.md
  ansible.builtin.template:
    src: mail-skill.md.j2
    dest: "{{ openclaw_imap_skills_dir }}/{{ openclaw_imap_command_skill_name }}/SKILL.md"
    owner: "1000"
    group: "1000"
    mode: "0640"
  notify: restart openclaw
