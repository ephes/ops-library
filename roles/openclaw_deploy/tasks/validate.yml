---
- name: validate | OpenClaw version is set
  ansible.builtin.assert:
    that:
      - openclaw_version | length > 0
    fail_msg: >-
      openclaw_version is required (e.g. "v2026.2.21"). Set it in the playbook or inventory.

- name: validate | Core OpenClaw settings
  ansible.builtin.assert:
    that:
      - openclaw_site_dir | length > 0
      - openclaw_data_dir | length > 0
      - openclaw_build_dir | length > 0
    fail_msg: >-
      Missing required OpenClaw settings (site_dir/data_dir/build_dir).

- name: validate | Extra env settings
  ansible.builtin.assert:
    that:
      - openclaw_extra_env is mapping
      - openclaw_extra_env is not string
    fail_msg: "openclaw_extra_env must be a mapping of environment variables."

- name: validate | Gateway token is set
  ansible.builtin.assert:
    that:
      - openclaw_gateway_token | length > 0
      - openclaw_gateway_token != 'CHANGEME'
    fail_msg: >-
      openclaw_gateway_token is required for gateway mode.
      Set it in the playbook or via SOPS secrets.

- name: validate | Anthropic API key is set
  ansible.builtin.assert:
    that:
      - openclaw_anthropic_api_key | length > 0
      - openclaw_anthropic_api_key != 'CHANGEME'
    fail_msg: >-
      openclaw_anthropic_api_key is required. Set it in the playbook or via SOPS secrets.

- name: validate | Optional OpenAI API key is not placeholder
  ansible.builtin.assert:
    that:
      - openclaw_openai_api_key != 'CHANGEME'
    fail_msg: >-
      openclaw_openai_api_key is optional, but when set it must not be CHANGEME.
  when: openclaw_openai_api_key | length > 0

- name: validate | Optional OpenRouter API key is not placeholder
  ansible.builtin.assert:
    that:
      - openclaw_openrouter_api_key != 'CHANGEME'
    fail_msg: >-
      openclaw_openrouter_api_key is optional, but when set it must not be CHANGEME.
  when: openclaw_openrouter_api_key | length > 0

- name: validate | Optional Ollama API key is not placeholder
  ansible.builtin.assert:
    that:
      - openclaw_ollama_api_key != 'CHANGEME'
    fail_msg: >-
      openclaw_ollama_api_key is optional, but when set it must not be CHANGEME.
  when: openclaw_ollama_api_key | length > 0

- name: validate | Optional Ollama base URL format
  ansible.builtin.assert:
    that:
      - openclaw_ollama_base_url is regex('^https?://')
    fail_msg: >-
      openclaw_ollama_base_url is optional, but when set it must start with http:// or https://.
  when: openclaw_ollama_base_url | length > 0

- name: validate | Optional model fallback policy shape
  ansible.builtin.assert:
    that:
      - openclaw_agent_model_fallbacks is sequence
      - openclaw_agent_model_fallbacks is not string
      - >-
        (
          openclaw_agent_model_fallbacks
          | map('trim')
          | reject('equalto', '')
          | list
          | length
        ) == (openclaw_agent_model_fallbacks | length)
    fail_msg: >-
      openclaw_agent_model_fallbacks must be a list of non-empty model IDs.

- name: validate | Optional model fallback entry format
  ansible.builtin.assert:
    that:
      - item is regex('^[^\\s]+/[^\\s]+$')
    fail_msg: >-
      Each entry in openclaw_agent_model_fallbacks must be in provider/model format.
      Invalid entry: {{ item }}
  loop: "{{ openclaw_agent_model_fallbacks }}"
  when: openclaw_agent_model_fallbacks | length > 0

- name: validate | Optional model fallback policy semantics
  ansible.builtin.assert:
    that:
      - openclaw_agent_model_primary | trim | length > 0
      - openclaw_agent_model_primary is regex('^[^\\s]+/[^\\s]+$')
      - >-
        (openclaw_agent_model_primary | trim)
        not in (openclaw_agent_model_fallbacks | map('trim') | list)
      - >-
        (
          openclaw_agent_model_fallbacks
          | map('trim')
          | unique
          | list
          | length
        ) == (openclaw_agent_model_fallbacks | length)
    fail_msg: >-
      openclaw_agent_model_primary must be set as provider/model when model fallbacks are configured.
      Fallbacks must be unique and must not contain the primary model.
  when: openclaw_agent_model_fallbacks | length > 0

- name: validate | Optional model primary format
  ansible.builtin.assert:
    that:
      - openclaw_agent_model_primary is regex('^[^\\s]+/[^\\s]+$')
    fail_msg: >-
      openclaw_agent_model_primary must be in provider/model format.
  when: openclaw_agent_model_primary | trim | length > 0

- name: validate | Telegram bot token when Telegram is enabled
  ansible.builtin.assert:
    that:
      - openclaw_telegram_bot_token | length > 0
      - openclaw_telegram_bot_token != 'CHANGEME'
    fail_msg: >-
      openclaw_telegram_bot_token is required when Telegram is enabled.
  when: openclaw_telegram_enabled | bool

- name: validate | Networking settings
  ansible.builtin.assert:
    that:
      - openclaw_bind_host | length > 0
      - openclaw_host_port | int > 0
      - openclaw_host_port | int <= 65535
      - openclaw_container_port | int > 0
      - openclaw_container_port | int <= 65535
    fail_msg: >-
      Invalid networking settings. openclaw_bind_host must be non-empty,
      ports must be between 1 and 65535.

- name: validate | Resource limits
  ansible.builtin.assert:
    that:
      - openclaw_mem_limit | string is regex('^[0-9]+[bkmgBKMG]$')
      - openclaw_cpus | float > 0
      - openclaw_pids_limit | int > 0
    fail_msg: >-
      Invalid resource limits. openclaw_mem_limit must match [0-9]+[bkmg] (e.g. "2g", "512m"),
      openclaw_cpus must be > 0, openclaw_pids_limit must be > 0.

- name: validate | Gateway config file mode format
  ansible.builtin.assert:
    that:
      - openclaw_gateway_config_mode | string is regex('^0?[0-7]{3,4}$')
    fail_msg: >-
      openclaw_gateway_config_mode must be a valid octal file mode string (for example "0600").

- name: validate | Gateway trusted proxies list
  ansible.builtin.assert:
    that:
      - openclaw_gateway_trusted_proxies is sequence
      - openclaw_gateway_trusted_proxies is not string
      - >-
        (
          openclaw_gateway_trusted_proxies
          | map('trim')
          | reject('equalto', '')
          | list
          | length
        ) == (openclaw_gateway_trusted_proxies | length)
    fail_msg: >-
      openclaw_gateway_trusted_proxies must be a list of non-empty proxy IP/CIDR strings.

- name: validate | Gateway auth rate limiting settings
  ansible.builtin.assert:
    that:
      - openclaw_gateway_auth_rate_limit_max_attempts | int > 0
      - openclaw_gateway_auth_rate_limit_window_ms | int > 0
      - openclaw_gateway_auth_rate_limit_lockout_ms | int >= 0
    fail_msg: >-
      Gateway auth rate limit values must be positive (lockout_ms can be 0).
  when: openclaw_gateway_auth_rate_limit_enabled | bool

- name: validate | Traefik settings when enabled
  ansible.builtin.assert:
    that:
      - openclaw_traefik_host | length > 0
      - openclaw_traefik_config_path | length > 0
      - openclaw_bind_host == '127.0.0.1' or openclaw_bind_host == 'localhost'
      - openclaw_gateway_trusted_proxies | length > 0
    fail_msg: >-
      openclaw_traefik_host and openclaw_traefik_config_path are required when Traefik is enabled.
      openclaw_bind_host must be 127.0.0.1 (loopback) and openclaw_gateway_trusted_proxies must be non-empty
      when Traefik is the external entry point.
  when: openclaw_traefik_enabled | bool

- name: validate | IMAP base settings when IMAP is enabled
  ansible.builtin.assert:
    that:
      - openclaw_imap_host | string | trim | length > 0
      - openclaw_imap_port | int > 0
      - openclaw_imap_port | int <= 65535
      - openclaw_imap_tls_mode in ['imaps', 'starttls']
      - openclaw_imap_default_mailbox | string | trim | length > 0
      - openclaw_imap_account_map is mapping
      - openclaw_imap_account_map is not string
      - openclaw_imap_account_map | length > 0
      - openclaw_imap_default_account | string | trim | length > 0
      - openclaw_imap_default_account in (openclaw_imap_account_map.keys() | list)
      - openclaw_imap_connect_timeout_seconds | int > 0
      - openclaw_imap_command_timeout_seconds | int > 0
      - openclaw_imap_default_limit | int > 0
      - (openclaw_imap_max_limit | int) >= (openclaw_imap_default_limit | int)
      - openclaw_imap_header_max_chars | int > 0
      - openclaw_imap_subject_max_chars | int > 0
      - openclaw_imap_search_query_max_chars | int > 0
      - openclaw_imap_read_fetch_bytes | int > 0
      - openclaw_imap_read_snippet_chars | int > 0
      - openclaw_imap_skills_dir | string | trim | length > 0
      - openclaw_imap_container_skills_dir | string | trim | length > 0
      - openclaw_imap_skill_name | string | trim | length > 0
      - openclaw_imap_command_skill_name | string | trim | length > 0
      - openclaw_imap_credentials_path | string | trim | length > 0
      - openclaw_imap_container_credentials_path | string | trim | length > 0
    fail_msg: >-
      Invalid IMAP settings. Configure host/port/tls/default account plus limits and paths when
      openclaw_imap_enabled is true.
  when: openclaw_imap_enabled | bool

- name: validate | IMAP account entries are valid
  ansible.builtin.assert:
    that:
      - item.value is mapping
      - item.value is not string
      - (item.value.mailbox | default(openclaw_imap_default_mailbox)) | string | trim | length > 0
      - item.value.username is defined
      - item.value.username | string | trim | length > 0
      - item.value.password is defined
      - item.value.password | string | trim | length > 0
    fail_msg: >-
      IMAP account {{ item.key }} must define mailbox (optional), username, and password.
  loop: "{{ openclaw_imap_account_map | dict2items }}"
  no_log: true
  when: openclaw_imap_enabled | bool

- name: validate | SMTP send requires IMAP command skill deployment
  ansible.builtin.assert:
    that:
      - openclaw_imap_enabled | bool
    fail_msg: >-
      openclaw_smtp_enabled requires openclaw_imap_enabled so the /mail command skill is deployed.
  when: openclaw_smtp_enabled | bool

- name: validate | SMTP base settings when SMTP send is enabled
  ansible.builtin.assert:
    that:
      - openclaw_smtp_host | string | trim | length > 0
      - openclaw_smtp_port | int > 0
      - openclaw_smtp_port | int <= 65535
      - openclaw_smtp_tls_mode in ['starttls', 'smtps']
      - openclaw_smtp_account_map is mapping
      - openclaw_smtp_account_map is not string
      - openclaw_smtp_account_map | length > 0
      - openclaw_smtp_default_account | string | trim | length > 0
      - openclaw_smtp_default_account in (openclaw_smtp_account_map.keys() | list)
      - openclaw_smtp_connect_timeout_seconds | int > 0
      - openclaw_smtp_command_timeout_seconds | int > 0
      - openclaw_smtp_max_recipients | int > 0
      - openclaw_smtp_address_max_chars | int >= 6
      - openclaw_smtp_from_name_max_chars | int > 0
      - openclaw_smtp_subject_max_chars | int > 0
      - openclaw_smtp_body_max_chars | int > 0
      - openclaw_smtp_credentials_path | string | trim | length > 0
      - openclaw_smtp_container_credentials_path | string | trim | length > 0
    fail_msg: >-
      Invalid SMTP send settings. Configure host/port/tls/default account, limits, and credential
      paths when openclaw_smtp_enabled is true.
  when: openclaw_smtp_enabled | bool

- name: validate | SMTP account entries are valid
  ansible.builtin.assert:
    that:
      - item.value is mapping
      - item.value is not string
      - item.value.username is defined
      - item.value.username | string | trim | length > 0
      - item.value.password is defined
      - item.value.password | string | trim | length > 0
      - item.value.from_address is defined
      - item.value.from_address | string | trim | length > 0
      - item.value.from_address | string | trim | length <= (openclaw_smtp_address_max_chars | int)
      - not (item.value.from_address | string is regex('[\\r\\n]'))
      - item.value.from_address | string | trim is regex('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$')
      - item.value.from_name | default('') | string | trim | length <= (openclaw_smtp_from_name_max_chars | int)
      - not (item.value.from_name | default('') | string is regex('[\\r\\n]'))
      - not (item.value.from_name | default('') | string is regex('[\\x00-\\x1f\\x7f]'))
      - (
          item.value.reply_to | default('') | string | trim | length == 0
        ) or (
          item.value.reply_to | default('') | string | trim | length <= (openclaw_smtp_address_max_chars | int)
          and not (item.value.reply_to | default('') | string is regex('[\\r\\n]'))
          and (item.value.reply_to | default('') | string | trim is regex('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$'))
        )
    fail_msg: >-
      SMTP account {{ item.key }} must define username/password/from_address with a valid sender
      address and no newline/control characters. Optional from_name/reply_to values must be valid.
  loop: "{{ openclaw_smtp_account_map | dict2items }}"
  no_log: true
  when: openclaw_smtp_enabled | bool

- name: validate | Home Assistant base settings when integration is enabled
  ansible.builtin.assert:
    that:
      - openclaw_homeassistant_base_url | string | trim | length > 0
      - openclaw_homeassistant_base_url is regex('^https?://')
      - not (openclaw_homeassistant_base_url | string is regex('[?#]'))
      - openclaw_homeassistant_token | string | trim | length > 0
      - openclaw_homeassistant_token != 'CHANGEME'
      - openclaw_homeassistant_skill_name | string | trim | length > 0
      - openclaw_homeassistant_command_skill_name | string | trim | length > 0
      - openclaw_homeassistant_skills_dir | string | trim | length > 0
      - openclaw_homeassistant_container_skills_dir | string | trim | length > 0
      - openclaw_homeassistant_credentials_path | string | trim | length > 0
      - openclaw_homeassistant_container_credentials_path | string | trim | length > 0
      - openclaw_homeassistant_request_timeout_seconds | int > 0
      - openclaw_homeassistant_default_limit | int > 0
      - openclaw_homeassistant_max_limit | int >= (openclaw_homeassistant_default_limit | int)
      - openclaw_homeassistant_state_max_chars | int > 0
      - openclaw_homeassistant_friendly_name_max_chars | int > 0
      - openclaw_homeassistant_attribute_max_items | int > 0
      - openclaw_homeassistant_attribute_value_max_chars | int > 0
      - openclaw_homeassistant_allow_domains is sequence
      - openclaw_homeassistant_allow_domains is not string
      - openclaw_homeassistant_allow_entities is sequence
      - openclaw_homeassistant_allow_entities is not string
      - openclaw_homeassistant_allow_write_domains is sequence
      - openclaw_homeassistant_allow_write_domains is not string
      - openclaw_homeassistant_allow_write_entities is sequence
      - openclaw_homeassistant_allow_write_entities is not string
      - >-
        (openclaw_homeassistant_allow_domains | length) > 0
        or (openclaw_homeassistant_allow_entities | length) > 0
    fail_msg: >-
      Invalid Home Assistant settings. Set base_url/token (without query/fragment),
      skill paths, limits/timeouts, and at least one
      allowlist (domain and/or entity) when openclaw_homeassistant_enabled is true.
  no_log: true
  when: openclaw_homeassistant_enabled | bool

- name: validate | Home Assistant allowed domains format
  ansible.builtin.assert:
    that:
      - item | string | trim | length > 0
      - item | string | trim is regex('^[a-z0-9_]+$')
    fail_msg: >-
      Invalid Home Assistant domain allowlist entry: {{ item }}.
      Domains must match ^[a-z0-9_]+$.
  loop: "{{ openclaw_homeassistant_allow_domains }}"
  when: openclaw_homeassistant_enabled | bool

- name: validate | Home Assistant allowed entities format
  ansible.builtin.assert:
    that:
      - item | string | trim | length > 0
      - item | string | trim is regex('^[a-z0-9_]+\\.[a-z0-9_]+$')
    fail_msg: >-
      Invalid Home Assistant entity allowlist entry: {{ item }}.
      Entity IDs must match domain.object_id (^[a-z0-9_]+\\.[a-z0-9_]+$).
  loop: "{{ openclaw_homeassistant_allow_entities }}"
  when: openclaw_homeassistant_enabled | bool

- name: validate | Home Assistant allowed write domains format
  ansible.builtin.assert:
    that:
      - item | string | trim | length > 0
      - item | string | trim is regex('^[a-z0-9_]+$')
    fail_msg: >-
      Invalid Home Assistant write-domain allowlist entry: {{ item }}.
      Domains must match ^[a-z0-9_]+$.
  loop: "{{ openclaw_homeassistant_allow_write_domains }}"
  when: openclaw_homeassistant_enabled | bool

- name: validate | Home Assistant allowed write entities format
  ansible.builtin.assert:
    that:
      - item | string | trim | length > 0
      - item | string | trim is regex('^[a-z0-9_]+\\.[a-z0-9_]+$')
    fail_msg: >-
      Invalid Home Assistant write-entity allowlist entry: {{ item }}.
      Entity IDs must match domain.object_id (^[a-z0-9_]+\\.[a-z0-9_]+$).
  loop: "{{ openclaw_homeassistant_allow_write_entities }}"
  when: openclaw_homeassistant_enabled | bool

- name: validate | Weeknotes backend when weeknotes is enabled
  ansible.builtin.assert:
    that:
      - openclaw_weeknotes_backend in ['local', 's3']
      - openclaw_weeknotes_reminder_command | length > 0
    fail_msg: "openclaw_weeknotes_backend must be either 'local' or 's3'."
  when: openclaw_weeknotes_enabled | bool

- name: validate | Weeknotes S3 settings when backend is s3
  ansible.builtin.assert:
    that:
      - openclaw_weeknotes_s3_endpoint | length > 0
      - openclaw_weeknotes_s3_bucket | length > 0
      - openclaw_weeknotes_s3_access_key | length > 0
      - openclaw_weeknotes_s3_secret_key | length > 0
      - openclaw_weeknotes_s3_note_key_format | length > 0
      - openclaw_weeknotes_s3_todo_list_mode in ['current_note', 'daily_notes']
      - openclaw_weeknotes_s3_todo_list_key_regex | length > 0
      - openclaw_weeknotes_s3_todo_cache_refresh_secs | int > 0
      - openclaw_weeknotes_s3_mc_host_path | length > 0
      - openclaw_weeknotes_s3_mc_container_path | length > 0
    fail_msg: >-
      openclaw_weeknotes_s3_endpoint, openclaw_weeknotes_s3_bucket,
      openclaw_weeknotes_s3_access_key, openclaw_weeknotes_s3_secret_key,
      openclaw_weeknotes_s3_note_key_format, openclaw_weeknotes_s3_todo_cache_refresh_secs,
      openclaw_weeknotes_s3_mc_host_path, and openclaw_weeknotes_s3_mc_container_path are required when
      openclaw_weeknotes_backend is s3.
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_backend == 's3'

- name: validate | Weeknotes S3 client binary exists on host
  ansible.builtin.stat:
    path: "{{ openclaw_weeknotes_s3_mc_host_path }}"
  register: openclaw_weeknotes_s3_mc_stat
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_backend == 's3'

- name: validate | Weeknotes S3 client binary is executable
  ansible.builtin.assert:
    that:
      - openclaw_weeknotes_s3_mc_stat.stat.exists
      - openclaw_weeknotes_s3_mc_stat.stat.executable
    fail_msg: >-
      openclaw_weeknotes_s3_mc_host_path must point to an executable MinIO client binary.
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_backend == 's3'
