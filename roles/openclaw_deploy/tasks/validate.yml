---
- name: validate | OpenClaw version is set
  ansible.builtin.assert:
    that:
      - openclaw_version | length > 0
    fail_msg: >-
      openclaw_version is required (e.g. "v2026.2.21"). Set it in the playbook or inventory.

- name: validate | Core OpenClaw settings
  ansible.builtin.assert:
    that:
      - openclaw_site_dir | length > 0
      - openclaw_data_dir | length > 0
      - openclaw_build_dir | length > 0
    fail_msg: >-
      Missing required OpenClaw settings (site_dir/data_dir/build_dir).

- name: validate | Extra env settings
  ansible.builtin.assert:
    that:
      - openclaw_extra_env is mapping
      - openclaw_extra_env is not string
    fail_msg: "openclaw_extra_env must be a mapping of environment variables."

- name: validate | Gateway token is set
  ansible.builtin.assert:
    that:
      - openclaw_gateway_token | length > 0
      - openclaw_gateway_token != 'CHANGEME'
    fail_msg: >-
      openclaw_gateway_token is required for gateway mode.
      Set it in the playbook or via SOPS secrets.

- name: validate | Anthropic API key is set
  ansible.builtin.assert:
    that:
      - openclaw_anthropic_api_key | length > 0
      - openclaw_anthropic_api_key != 'CHANGEME'
    fail_msg: >-
      openclaw_anthropic_api_key is required. Set it in the playbook or via SOPS secrets.

- name: validate | Telegram bot token when Telegram is enabled
  ansible.builtin.assert:
    that:
      - openclaw_telegram_bot_token | length > 0
      - openclaw_telegram_bot_token != 'CHANGEME'
    fail_msg: >-
      openclaw_telegram_bot_token is required when Telegram is enabled.
  when: openclaw_telegram_enabled | bool

- name: validate | Networking settings
  ansible.builtin.assert:
    that:
      - openclaw_bind_host | length > 0
      - openclaw_host_port | int > 0
      - openclaw_host_port | int <= 65535
      - openclaw_container_port | int > 0
      - openclaw_container_port | int <= 65535
    fail_msg: >-
      Invalid networking settings. openclaw_bind_host must be non-empty,
      ports must be between 1 and 65535.

- name: validate | Resource limits
  ansible.builtin.assert:
    that:
      - openclaw_mem_limit | string is regex('^[0-9]+[bkmgBKMG]$')
      - openclaw_cpus | float > 0
      - openclaw_pids_limit | int > 0
    fail_msg: >-
      Invalid resource limits. openclaw_mem_limit must match [0-9]+[bkmg] (e.g. "2g", "512m"),
      openclaw_cpus must be > 0, openclaw_pids_limit must be > 0.

- name: validate | Traefik settings when enabled
  ansible.builtin.assert:
    that:
      - openclaw_traefik_host | length > 0
      - openclaw_traefik_config_path | length > 0
      - openclaw_bind_host == '127.0.0.1' or openclaw_bind_host == 'localhost'
    fail_msg: >-
      openclaw_traefik_host and openclaw_traefik_config_path are required when Traefik is enabled.
      openclaw_bind_host must be 127.0.0.1 (loopback) when Traefik is the external entry point.
  when: openclaw_traefik_enabled | bool

- name: validate | Weeknotes backend when weeknotes is enabled
  ansible.builtin.assert:
    that:
      - openclaw_weeknotes_backend in ['local', 's3']
      - openclaw_weeknotes_reminder_command | length > 0
    fail_msg: "openclaw_weeknotes_backend must be either 'local' or 's3'."
  when: openclaw_weeknotes_enabled | bool

- name: validate | Weeknotes S3 settings when backend is s3
  ansible.builtin.assert:
    that:
      - openclaw_weeknotes_s3_endpoint | length > 0
      - openclaw_weeknotes_s3_bucket | length > 0
      - openclaw_weeknotes_s3_access_key | length > 0
      - openclaw_weeknotes_s3_secret_key | length > 0
      - openclaw_weeknotes_s3_note_key_format | length > 0
      - openclaw_weeknotes_s3_todo_list_mode in ['current_note', 'daily_notes']
      - openclaw_weeknotes_s3_todo_list_key_regex | length > 0
      - openclaw_weeknotes_s3_todo_cache_refresh_secs | int > 0
      - openclaw_weeknotes_s3_mc_host_path | length > 0
      - openclaw_weeknotes_s3_mc_container_path | length > 0
    fail_msg: >-
      openclaw_weeknotes_s3_endpoint, openclaw_weeknotes_s3_bucket,
      openclaw_weeknotes_s3_access_key, openclaw_weeknotes_s3_secret_key,
      openclaw_weeknotes_s3_note_key_format, openclaw_weeknotes_s3_todo_cache_refresh_secs,
      openclaw_weeknotes_s3_mc_host_path, and openclaw_weeknotes_s3_mc_container_path are required when
      openclaw_weeknotes_backend is s3.
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_backend == 's3'

- name: validate | Weeknotes S3 client binary exists on host
  ansible.builtin.stat:
    path: "{{ openclaw_weeknotes_s3_mc_host_path }}"
  register: openclaw_weeknotes_s3_mc_stat
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_backend == 's3'

- name: validate | Weeknotes S3 client binary is executable
  ansible.builtin.assert:
    that:
      - openclaw_weeknotes_s3_mc_stat.stat.exists
      - openclaw_weeknotes_s3_mc_stat.stat.executable
    fail_msg: >-
      openclaw_weeknotes_s3_mc_host_path must point to an executable MinIO client binary.
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_backend == 's3'
