---
- name: env | Assemble OpenClaw environment
  ansible.builtin.set_fact:
    openclaw_env: "{{ openclaw_env_defaults | combine(openclaw_extra_env, recursive=True) }}"
  no_log: true
  vars:
    openclaw_env_defaults:
      OPENCLAW_GATEWAY_TOKEN: "{{ openclaw_gateway_token }}"
      ANTHROPIC_API_KEY: "{{ openclaw_anthropic_api_key }}"
      TELEGRAM_BOT_TOKEN: "{{ openclaw_telegram_bot_token }}"
      NODE_OPTIONS: "--max-old-space-size={{ openclaw_node_max_old_space_size }}"

- name: env | Add optional OpenAI API key to environment
  ansible.builtin.set_fact:
    openclaw_env: "{{ openclaw_env | combine({'OPENAI_API_KEY': openclaw_openai_api_key}) }}"
  when: openclaw_openai_api_key | length > 0
  no_log: true

- name: env | Add timezone to environment
  ansible.builtin.set_fact:
    openclaw_env: "{{ openclaw_env | combine({'TZ': openclaw_weeknotes_tz}) }}"
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_tz | length > 0
  no_log: true

- name: env | Add weeknotes S3 environment when backend is s3
  ansible.builtin.set_fact:
    openclaw_env: >-
      {{
        openclaw_env | combine({
          'OPENCLAW_WEEKNOTES_S3_ENDPOINT': openclaw_weeknotes_s3_endpoint,
          'OPENCLAW_WEEKNOTES_S3_REGION': openclaw_weeknotes_s3_region,
          'OPENCLAW_WEEKNOTES_S3_BUCKET': openclaw_weeknotes_s3_bucket,
          'OPENCLAW_WEEKNOTES_S3_PREFIX': openclaw_weeknotes_s3_prefix,
          'OPENCLAW_WEEKNOTES_S3_ACCESS_KEY': openclaw_weeknotes_s3_access_key,
          'OPENCLAW_WEEKNOTES_S3_SECRET_KEY': openclaw_weeknotes_s3_secret_key,
          'OPENCLAW_WEEKNOTES_S3_NOTE_KEY_FORMAT': openclaw_weeknotes_s3_note_key_format,
          'OPENCLAW_WEEKNOTES_S3_TODO_LIST_MODE': openclaw_weeknotes_s3_todo_list_mode,
          'OPENCLAW_WEEKNOTES_S3_TODO_LIST_KEY_REGEX': openclaw_weeknotes_s3_todo_list_key_regex,
          'OPENCLAW_WEEKNOTES_S3_TODO_CACHE_REFRESH_SECS': openclaw_weeknotes_s3_todo_cache_refresh_secs | string,
          'OPENCLAW_WEEKNOTES_S3_MC_ALIAS': openclaw_weeknotes_s3_mc_alias,
          'OPENCLAW_WEEKNOTES_S3_MC_BIN': openclaw_weeknotes_s3_mc_container_path
        })
      }}
  when:
    - openclaw_weeknotes_enabled | bool
    - openclaw_weeknotes_backend == 's3'
  no_log: true

- name: env | Render OpenClaw environment file
  ansible.builtin.template:
    src: openclaw.env.j2
    dest: "{{ openclaw_site_dir }}/.env"
    owner: root
    group: root
    mode: "0600"
  no_log: true
  notify: restart openclaw
