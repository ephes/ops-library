---
- name: config | Check if gateway config exists
  ansible.builtin.stat:
    path: "{{ openclaw_data_dir }}/openclaw.json"
  register: openclaw_config_stat

- name: config | Build gateway config from individual variables
  ansible.builtin.set_fact:
    _openclaw_gateway_access_patch: >-
      {{
        {
          "gateway": {
            "bind": ("lan" if (openclaw_traefik_enabled | bool) else "loopback"),
            "trustedProxies": openclaw_gateway_trusted_proxies,
            "allowRealIpFallback": openclaw_gateway_allow_real_ip_fallback | bool
          }
        }
        | combine(
            (
              {
                "gateway": {
                  "auth": {
                    "rateLimit": {
                      "maxAttempts": openclaw_gateway_auth_rate_limit_max_attempts | int,
                      "windowMs": openclaw_gateway_auth_rate_limit_window_ms | int,
                      "lockoutMs": openclaw_gateway_auth_rate_limit_lockout_ms | int,
                      "exemptLoopback": openclaw_gateway_auth_rate_limit_exempt_loopback | bool
                    }
                  }
                }
              }
              if (openclaw_gateway_auth_rate_limit_enabled | bool)
              else {}
            ),
            recursive=True
          )
        | combine(
            (
              {
                "gateway": {
                  "controlUi": {
                    "allowedOrigins": [("https://" ~ openclaw_traefik_host)]
                  }
                }
              }
              if (openclaw_traefik_enabled | bool)
              else {}
            ),
            recursive=True
          )
      }}
  when: openclaw_gateway_config | length == 0

- name: config | Build optional model policy patch
  ansible.builtin.set_fact:
    _openclaw_model_policy_patch: >-
      {{
        {
          "agents": {
            "defaults": {
              "model": {
                "primary": openclaw_agent_model_primary | trim,
                "fallbacks": openclaw_agent_model_fallbacks | map('trim') | list
              }
            }
          }
        }
      }}
  when:
    - openclaw_gateway_config | length == 0
    - openclaw_agent_model_primary | trim | length > 0

- name: config | Build gateway config from individual variables
  ansible.builtin.set_fact:
    _openclaw_built_config: >-
      {{
        {
          "channels": {
            "telegram": {
              "enabled": openclaw_telegram_enabled | bool,
              "dmPolicy": openclaw_telegram_dm_policy,
              "allowFrom": openclaw_telegram_allow_from
            }
          },
          "plugins": {
            "entries": {
              "telegram": { "enabled": openclaw_telegram_enabled | bool },
              "whatsapp": { "enabled": false }
            }
          }
        }
        | combine(_openclaw_gateway_access_patch, recursive=True)
        | combine(_openclaw_model_policy_patch | default({}), recursive=True)
      }}
  when: openclaw_gateway_config | length == 0

- name: config | Render OpenClaw gateway config (seed)
  ansible.builtin.template:
    src: openclaw-config.json.j2
    dest: "{{ openclaw_data_dir }}/openclaw.json"
    owner: "1000"
    group: "1000"
    mode: "{{ openclaw_gateway_config_mode }}"
  no_log: true
  when: not openclaw_config_stat.stat.exists or (openclaw_force_config | bool)
  notify: restart openclaw

- name: config | Ensure WhatsApp plugin is disabled in existing config
  when: openclaw_config_stat.stat.exists and not (openclaw_force_config | bool)
  no_log: true
  block:
    - name: config | Read existing gateway config
      ansible.builtin.slurp:
        src: "{{ openclaw_data_dir }}/openclaw.json"
      register: _openclaw_existing_config_raw

    - name: config | Parse existing gateway config
      ansible.builtin.set_fact:
        _openclaw_existing_config: "{{ _openclaw_existing_config_raw.content | b64decode | from_json }}"

    - name: config | Build runtime config patch
      ansible.builtin.set_fact:
        _openclaw_runtime_patch: >-
          {{
            {
              "plugins": {
                "entries": {
                  "whatsapp": {
                    "enabled": false
                  }
                }
              },
              "gateway": {
                "bind": ("lan" if (openclaw_traefik_enabled | bool) else "loopback"),
                "trustedProxies": openclaw_gateway_trusted_proxies,
                "allowRealIpFallback": openclaw_gateway_allow_real_ip_fallback | bool
              }
            }
            | combine(
                (
                  {
                    "gateway": {
                      "auth": {
                        "rateLimit": {
                          "maxAttempts": openclaw_gateway_auth_rate_limit_max_attempts | int,
                          "windowMs": openclaw_gateway_auth_rate_limit_window_ms | int,
                          "lockoutMs": openclaw_gateway_auth_rate_limit_lockout_ms | int,
                          "exemptLoopback": openclaw_gateway_auth_rate_limit_exempt_loopback | bool
                        }
                      }
                    }
                  }
                  if (openclaw_gateway_auth_rate_limit_enabled | bool)
                  else {}
                ),
                recursive=True
              )
            | combine(
                (
                  {
                    "gateway": {
                      "controlUi": {
                        "allowedOrigins": [("https://" ~ openclaw_traefik_host)]
                      }
                    }
                  }
                  if (openclaw_traefik_enabled | bool)
                  else {}
                ),
                recursive=True
              )
            | combine(_openclaw_model_policy_patch | default({}), recursive=True)
          }}

    - name: config | Merge runtime config patch
      ansible.builtin.set_fact:
        _openclaw_patched_config: "{{ _openclaw_existing_config | combine(_openclaw_runtime_patch, recursive=True) }}"

    - name: config | Persist runtime config patch
      ansible.builtin.copy:
        content: "{{ _openclaw_patched_config | to_nice_json }}\n"
        dest: "{{ openclaw_data_dir }}/openclaw.json"
        owner: "1000"
        group: "1000"
        mode: "{{ openclaw_gateway_config_mode }}"
      when: _openclaw_patched_config != _openclaw_existing_config
      notify: restart openclaw

- name: config | Render SOUL.md (system prompt)
  ansible.builtin.copy:
    content: "{{ openclaw_reply_system_prompt }}"
    dest: "{{ openclaw_data_dir }}/SOUL.md"
    owner: "1000"
    group: "1000"
    mode: "0644"
  notify: restart openclaw
  when: openclaw_reply_system_prompt | length > 0
