---
# Configure Samba users for general shares (idempotent).

- name: users | Ensure Unix users exist for Samba users
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ samba_share_system_group }}"
    append: true
    create_home: false
    shell: /usr/sbin/nologin
    state: present
  loop: "{{ samba_share_users }}"
  loop_control:
    label: "{{ item.name }}"
  when: samba_share_manage_system_users

- name: users | Check existing Samba users
  ansible.builtin.command:
    cmd: pdbedit -L -u {{ item.name | quote }}
  loop: "{{ samba_share_users }}"
  loop_control:
    label: "{{ item.name }}"
  register: _samba_user_check
  changed_when: false
  failed_when: false

- name: users | Identify users to create
  ansible.builtin.set_fact:
    _samba_users_to_create: >-
      {{
        samba_share_users | zip(_samba_user_check.results)
        | selectattr('1.rc', 'ne', 0)
        | map(attribute='0')
        | list
      }}

- name: users | Create new Samba users
  ansible.builtin.shell:
    cmd: |
      printf '%s\n' {{ item.password | quote }} {{ item.password | quote }} | smbpasswd -a -s {{ item.name | quote }}
  loop: "{{ _samba_users_to_create }}"
  loop_control:
    label: "{{ item.name }}"
  no_log: true
  when: _samba_users_to_create | length > 0
  register: _samba_users_create_result
  changed_when: _samba_users_create_result.rc == 0

- name: users | Enable Samba users
  ansible.builtin.command:
    cmd: smbpasswd -e {{ item.name | quote }}
  loop: "{{ _samba_users_to_create }}"
  loop_control:
    label: "{{ item.name }}"
  when: _samba_users_to_create | length > 0
  register: _samba_users_enable_result
  changed_when: _samba_users_enable_result.rc == 0
