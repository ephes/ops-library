---
# mail_backup - Create mail server backup

- name: Get timestamp for backup
  ansible.builtin.set_fact:
    mail_backup_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

- name: Compute backup directory name
  ansible.builtin.set_fact:
    mail_backup_dir_name: "{{ mail_backup_prefix }}-{{ mail_backup_timestamp }}"
    mail_backup_dir: "{{ mail_backup_destination }}/{{ mail_backup_prefix }}-{{ mail_backup_timestamp }}"

- name: Ensure backup parent directory exists
  ansible.builtin.file:
    path: "{{ mail_backup_destination | dirname }}"
    state: directory
    owner: "{{ mail_backup_owner }}"
    group: "{{ mail_backup_group }}"
    mode: "{{ mail_backup_dir_mode }}"

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ mail_backup_destination }}"
    state: directory
    owner: "{{ mail_backup_owner }}"
    group: "{{ mail_backup_group }}"
    mode: "{{ mail_backup_dir_mode }}"

- name: Create timestamped backup directory
  ansible.builtin.file:
    path: "{{ mail_backup_dir }}"
    state: directory
    owner: "{{ mail_backup_owner }}"
    group: "{{ mail_backup_group }}"
    mode: "{{ mail_backup_dir_mode }}"

- name: Backup PostgreSQL database
  ansible.builtin.shell: |
    pg_dump -U postgres {{ mail_backup_postgres_database }} | gzip > \
      "{{ mail_backup_dir }}/database.sql.gz"
  become: true
  become_user: postgres
  when: mail_backup_database
  changed_when: true

- name: Backup maildir
  ansible.builtin.shell: |
    tar -czf "{{ mail_backup_dir }}/maildir.tar.gz" \
      -C "{{ mail_backup_vmail_path | dirname }}" "{{ mail_backup_vmail_path | basename }}"
  when: mail_backup_maildir
  changed_when: true

- name: Backup configuration files
  ansible.builtin.archive:
    path: "{{ mail_backup_config_paths }}"
    dest: "{{ mail_backup_dir }}/config.tar.gz"
    format: gz
  when: mail_backup_config

- name: Create backup manifest
  ansible.builtin.copy:
    content: |
      # Mail Backup Manifest
      timestamp: {{ mail_backup_timestamp }}
      prefix: {{ mail_backup_prefix }}
      created: {{ ansible_date_time.iso8601 }}
      host: {{ inventory_hostname }}
      components:
        database: {{ mail_backup_database }}
        maildir: {{ mail_backup_maildir }}
        config: {{ mail_backup_config }}
      paths:
        vmail: {{ mail_backup_vmail_path }}
        database: {{ mail_backup_postgres_database }}
        config_paths: {{ mail_backup_config_paths | to_json }}
    dest: "{{ mail_backup_dir }}/manifest.yml"
    owner: "{{ mail_backup_owner }}"
    group: "{{ mail_backup_owner }}"
    mode: "{{ mail_backup_file_mode }}"

# =============================================================================
# Archive Creation
# =============================================================================

- name: Compute archive path
  ansible.builtin.set_fact:
    mail_backup_archive_path: "{{ mail_backup_destination }}/{{ mail_backup_dir_name }}.{{ mail_backup_archive_format }}"
  when: mail_backup_create_archive

- name: Create tar.gz archive
  ansible.builtin.command:
    cmd: >
      tar -C "{{ mail_backup_destination }}"
      -czf "{{ mail_backup_archive_path }}"
      "{{ mail_backup_dir_name }}"
  when:
    - mail_backup_create_archive
    - mail_backup_archive_format == 'tar.gz'
  changed_when: true

- name: Create tar.zst archive
  ansible.builtin.command:
    cmd: >
      tar -C "{{ mail_backup_destination }}"
      --zstd -cf "{{ mail_backup_archive_path }}"
      "{{ mail_backup_dir_name }}"
  when:
    - mail_backup_create_archive
    - mail_backup_archive_format == 'tar.zst'
  changed_when: true

- name: Set archive permissions for fetch (owner-only read)
  ansible.builtin.file:
    path: "{{ mail_backup_archive_path }}"
    owner: "{{ mail_backup_owner }}"
    group: "{{ mail_backup_group }}"
    mode: "0600"
  when:
    - mail_backup_create_archive
    - mail_backup_fetch_local

# =============================================================================
# Fetch to Controller
# =============================================================================

- name: Ensure local archive directory exists
  ansible.builtin.file:
    path: "{{ mail_backup_local_dir }}"
    state: directory
    mode: "{{ mail_backup_local_dir_mode }}"
  delegate_to: localhost
  become: false
  run_once: true
  when:
    - mail_backup_fetch_local
    - mail_backup_create_archive

- name: Fetch archive to control machine via synchronize
  ansible.posix.synchronize:
    mode: pull
    src: "{{ mail_backup_archive_path }}"
    dest: "{{ mail_backup_local_dir }}/"
    archive: false
    rsync_opts:
      - "--chmod=u=rw,go="
  delegate_to: localhost
  become: false
  run_once: true
  when:
    - mail_backup_fetch_local
    - mail_backup_create_archive
    - mail_backup_fetch_method == 'synchronize'

- name: Fetch archive to control machine via fetch
  ansible.builtin.fetch:
    src: "{{ mail_backup_archive_path }}"
    dest: "{{ mail_backup_local_dir }}/"
    flat: true
  run_once: true
  when:
    - mail_backup_fetch_local
    - mail_backup_create_archive
    - mail_backup_fetch_method == 'fetch'

# =============================================================================
# Cleanup and Reporting
# =============================================================================

- name: Remove old backup directories (not archives)
  ansible.builtin.shell: |
    set -euo pipefail
    find "{{ mail_backup_destination }}" -mindepth 1 -maxdepth 1 -type d \
      -name '{{ mail_backup_prefix }}-*' -mtime +{{ mail_backup_retention_days }} \
      -exec rm -rf -- {} +
  args:
    executable: /bin/bash
  changed_when: false

- name: Remove old backup archives
  ansible.builtin.shell: |
    set -euo pipefail
    find "{{ mail_backup_destination }}" -mindepth 1 -maxdepth 1 -type f \
      \( -name '{{ mail_backup_prefix }}-*.tar.gz' -o -name '{{ mail_backup_prefix }}-*.tar.zst' \) \
      -mtime +{{ mail_backup_retention_days }} -delete
  args:
    executable: /bin/bash
  changed_when: false
  when: mail_backup_create_archive

- name: Set backup artifact path
  ansible.builtin.set_fact:
    mail_backup_artifact_path: "{{ mail_backup_archive_path if mail_backup_create_archive else mail_backup_dir }}"

- name: Gather backup size
  ansible.builtin.command:
    cmd: "du -sh {{ mail_backup_artifact_path | quote }}"
  register: mail_backup_size_cmd
  changed_when: false
  when: mail_backup_report_size

- name: Report backup completion
  ansible.builtin.debug:
    msg: |
      Backup complete: {{ mail_backup_artifact_path }}
      Size: {{ mail_backup_size_cmd.stdout | default('unknown') }}
      {% if mail_backup_fetch_local and mail_backup_create_archive %}
      Fetched to: {{ mail_backup_local_dir }}/{{ mail_backup_dir_name }}.{{ mail_backup_archive_format }}
      {% endif %}
  when: mail_backup_report_size
