---
# mail_backup - Create mail server backup

- name: Get timestamp for backup
  ansible.builtin.set_fact:
    mail_backup_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

- name: Ensure backup parent directory exists
  ansible.builtin.file:
    path: "{{ mail_backup_destination | dirname }}"
    state: directory
    owner: root
    group: postgres
    mode: "0770"

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ mail_backup_destination }}"
    state: directory
    owner: postgres
    group: postgres
    mode: "0770"

- name: Create timestamped backup directory
  ansible.builtin.file:
    path: "{{ mail_backup_destination }}/{{ mail_backup_timestamp }}"
    state: directory
    owner: postgres
    group: postgres
    mode: "0770"

- name: Backup PostgreSQL database
  ansible.builtin.shell: |
    pg_dump -U postgres {{ mail_backup_postgres_database }} | gzip > \
      "{{ mail_backup_destination }}/{{ mail_backup_timestamp }}/database.sql.gz"
  become: true
  become_user: postgres
  when: mail_backup_database
  changed_when: true

- name: Backup maildir
  ansible.builtin.shell: |
    tar -czf "{{ mail_backup_destination }}/{{ mail_backup_timestamp }}/maildir.tar.gz" \
      -C "{{ mail_backup_vmail_path | dirname }}" "{{ mail_backup_vmail_path | basename }}"
  when: mail_backup_maildir
  changed_when: true

- name: Backup configuration files
  ansible.builtin.archive:
    path: "{{ mail_backup_config_paths }}"
    dest: "{{ mail_backup_destination }}/{{ mail_backup_timestamp }}/config.tar.gz"
    format: gz
  when: mail_backup_config

- name: Create backup manifest
  ansible.builtin.copy:
    content: |
      # Mail Backup Manifest
      timestamp: {{ mail_backup_timestamp }}
      created: {{ ansible_date_time.iso8601 }}
      host: {{ inventory_hostname }}
      components:
        database: {{ mail_backup_database }}
        maildir: {{ mail_backup_maildir }}
        config: {{ mail_backup_config }}
      paths:
        vmail: {{ mail_backup_vmail_path }}
        database: {{ mail_backup_postgres_database }}
    dest: "{{ mail_backup_destination }}/{{ mail_backup_timestamp }}/manifest.yml"
    owner: root
    group: root
    mode: "0640"

- name: Remove old backups
  ansible.builtin.shell: |
    find "{{ mail_backup_destination }}" -maxdepth 1 -type d -mtime +{{ mail_backup_retention_days }} \
      -not -path "{{ mail_backup_destination }}" -exec rm -rf {} \;
  changed_when: false

- name: Display backup location
  ansible.builtin.debug:
    msg: "Backup created at: {{ mail_backup_destination }}/{{ mail_backup_timestamp }}"
