-- Mail server database schema
-- Generated by Ansible - do not edit manually
-- Role: mail_backend_deploy

-- =============================================================================
-- Virtual domains
-- =============================================================================
CREATE TABLE IF NOT EXISTS mail_domains (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Case-insensitive unique constraint on domain name
CREATE UNIQUE INDEX IF NOT EXISTS mail_domains_name_ci ON mail_domains (LOWER(name));

-- =============================================================================
-- Virtual users (mailboxes)
-- =============================================================================
-- Uses localpart + domain_id as composite key to allow same localpart across domains
-- e.g., info@wersdörfer.de and info@wersdoerfer.de can be separate mailboxes
CREATE TABLE IF NOT EXISTS mail_users (
    id SERIAL PRIMARY KEY,
    domain_id INTEGER NOT NULL REFERENCES mail_domains(id) ON DELETE CASCADE,
    localpart VARCHAR(255) NOT NULL,  -- just the part before @
    password VARCHAR(255) NOT NULL,   -- {{ mail_backend_password_scheme }}
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Case-insensitive unique constraint on localpart within domain
CREATE UNIQUE INDEX IF NOT EXISTS mail_users_domain_localpart_ci ON mail_users (domain_id, LOWER(localpart));

-- =============================================================================
-- Virtual aliases
-- =============================================================================
-- source_localpart + source_domain_id defines the alias address
-- destination is the full target email (can be external or cross-domain)
CREATE TABLE IF NOT EXISTS mail_aliases (
    id SERIAL PRIMARY KEY,
    source_domain_id INTEGER NOT NULL REFERENCES mail_domains(id) ON DELETE CASCADE,
    source_localpart VARCHAR(255) NOT NULL,  -- e.g., "info", or "*" for catch-all
    destination VARCHAR(255) NOT NULL,        -- full email, e.g., "user@example.com"
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Case-insensitive unique constraint
CREATE UNIQUE INDEX IF NOT EXISTS mail_aliases_unique_ci
    ON mail_aliases (source_domain_id, LOWER(source_localpart), LOWER(destination));

-- =============================================================================
-- Domain aliases (optional: alias entire domain to another)
-- =============================================================================
-- e.g., all mail to wersdörfer.de → wersdoerfer.de
CREATE TABLE IF NOT EXISTS mail_domain_aliases (
    id SERIAL PRIMARY KEY,
    source_domain_id INTEGER NOT NULL REFERENCES mail_domains(id) ON DELETE CASCADE,
    dest_domain_id INTEGER NOT NULL REFERENCES mail_domains(id) ON DELETE CASCADE,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(source_domain_id)
);

-- =============================================================================
-- Views for Postfix/Dovecot lookups
-- =============================================================================

-- Helper view for Postfix/Dovecot lookups (constructs full email)
-- Maildir path derived from domain/localpart pattern
CREATE OR REPLACE VIEW mail_users_view AS
SELECT
    u.id,
    u.localpart || '@' || d.name AS email,
    u.password,
    d.name || '/' || u.localpart || '/' AS maildir,  -- e.g., wersdoerfer.de/jochen/
    u.active
FROM mail_users u
JOIN mail_domains d ON u.domain_id = d.id
WHERE u.active AND d.active;

-- Alias view for Postfix virtual_alias_maps
-- Includes regular aliases; catch-all uses source_localpart = '*'
CREATE OR REPLACE VIEW mail_aliases_view AS
SELECT
    a.id,
    a.source_localpart || '@' || d.name AS source,
    a.destination,
    a.active
FROM mail_aliases a
JOIN mail_domains d ON a.source_domain_id = d.id
WHERE a.active AND d.active AND a.source_localpart != '*';

-- Catch-all view (for secondary lookup after exact match fails)
CREATE OR REPLACE VIEW mail_catchall_view AS
SELECT
    a.id,
    d.name AS domain,
    a.destination
FROM mail_aliases a
JOIN mail_domains d ON a.source_domain_id = d.id
WHERE a.source_localpart = '*' AND a.active AND d.active;

-- Domain aliases: listing configured domain→domain mappings
CREATE OR REPLACE VIEW mail_domain_aliases_list AS
SELECT
    da.id,
    sd.name AS source_domain,
    dd.name AS dest_domain
FROM mail_domain_aliases da
JOIN mail_domains sd ON da.source_domain_id = sd.id
JOIN mail_domains dd ON da.dest_domain_id = dd.id
WHERE da.active AND sd.active AND dd.active;

-- Domain aliases expanded: generates alias entries for all users in dest domain
-- Use as additional virtual_alias_maps source in Postfix
CREATE OR REPLACE VIEW mail_domain_aliases_expanded AS
SELECT
    u.localpart || '@' || sd.name AS source,
    u.localpart || '@' || dd.name AS destination
FROM mail_domain_aliases da
JOIN mail_domains sd ON da.source_domain_id = sd.id
JOIN mail_domains dd ON da.dest_domain_id = dd.id
JOIN mail_users u ON u.domain_id = da.dest_domain_id
WHERE da.active AND sd.active AND dd.active AND u.active;

-- =============================================================================
-- Sender login map view (for reject_sender_login_mismatch)
-- =============================================================================
-- Maps sender addresses to allowed login usernames
CREATE OR REPLACE VIEW mail_sender_login_view AS
-- Users can send as their own address
SELECT
    u.localpart || '@' || d.name AS sender,
    u.localpart || '@' || d.name AS login
FROM mail_users u
JOIN mail_domains d ON u.domain_id = d.id
WHERE u.active AND d.active
UNION
-- Users can send as aliases that point to them
SELECT
    a.source_localpart || '@' || d.name AS sender,
    a.destination AS login
FROM mail_aliases a
JOIN mail_domains d ON a.source_domain_id = d.id
WHERE a.active AND d.active
  AND a.destination LIKE '%@%'
  AND a.source_localpart != '*';
