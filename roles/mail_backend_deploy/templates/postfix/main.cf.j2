# Postfix main.cf - Backend Mail Server Configuration
# Generated by Ansible - do not edit manually
# Role: mail_backend_deploy

# =============================================================================
# Basic Settings
# =============================================================================

myhostname = {{ mail_backend_hostname }}
mydomain = {{ mail_backend_mydomain }}
myorigin = $mydomain

inet_interfaces = {{ mail_backend_inet_interfaces }}
inet_protocols = {{ mail_backend_inet_protocols }}

# Not a final destination for system mail - all mail is virtual
mydestination =
local_recipient_maps =
local_transport = error:local delivery disabled

# Trusted networks (edge relay + localhost)
mynetworks = {{ mail_backend_mynetworks | join(', ') }}

# =============================================================================
# Virtual Mailbox Configuration
# =============================================================================

# Virtual domains from PostgreSQL
virtual_mailbox_domains = proxy:pgsql:/etc/postfix/sql/virtual_domains.cf

# Virtual mailboxes from PostgreSQL
virtual_mailbox_maps = proxy:pgsql:/etc/postfix/sql/virtual_mailboxes.cf

# Virtual mailbox base path
virtual_mailbox_base = {{ mail_backend_vmail_path }}

# Virtual mail user/group
virtual_uid_maps = static:{{ mail_backend_vmail_uid }}
virtual_gid_maps = static:{{ mail_backend_vmail_gid }}
virtual_minimum_uid = {{ mail_backend_vmail_uid }}

# =============================================================================
# Virtual Alias Configuration
# =============================================================================

# Alias lookup order:
# 1. Explicit aliases (localpart@domain → destination)
# 2. Catch-all (*@domain → destination)
# 3. Domain aliases (user@domain1 → user@domain2 for all users)
virtual_alias_maps =
    proxy:pgsql:/etc/postfix/sql/virtual_aliases.cf,
    proxy:pgsql:/etc/postfix/sql/virtual_catchall.cf,
    proxy:pgsql:/etc/postfix/sql/virtual_domain_aliases.cf

# =============================================================================
# Local Delivery via Dovecot LMTP
# =============================================================================

virtual_transport = lmtp:unix:private/dovecot-lmtp

# =============================================================================
# Outbound Relay via Edge
# =============================================================================

# Use edge server as smarthost for outbound mail
relayhost = [{{ mail_backend_relay_host }}]:{{ mail_backend_relay_port }}

# SASL authentication to edge
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/relay_password
smtp_sasl_security_options = noanonymous
smtp_sasl_tls_security_options = noanonymous

# =============================================================================
# TLS Configuration - Inbound
# =============================================================================

{% if mail_backend_tls_enabled %}
smtpd_tls_security_level = {{ mail_backend_smtpd_tls_security_level }}
smtpd_tls_cert_file = {{ mail_backend_tls_cert }}
smtpd_tls_key_file = {{ mail_backend_tls_key }}
smtpd_tls_protocols = {{ mail_backend_tls_protocols }}
smtpd_tls_mandatory_protocols = {{ mail_backend_tls_protocols }}
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes
{% endif %}

# =============================================================================
# TLS Configuration - Outbound
# =============================================================================

{% if mail_backend_tls_enabled %}
smtp_tls_security_level = {{ mail_backend_smtp_tls_security_level }}
smtp_tls_protocols = {{ mail_backend_tls_protocols }}
smtp_tls_mandatory_protocols = {{ mail_backend_tls_protocols }}
smtp_tls_loglevel = 1
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
{% endif %}

# =============================================================================
# SASL Authentication (for submission)
# =============================================================================

# Use Dovecot for SASL authentication
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname

# =============================================================================
# Sender/Login Binding
# =============================================================================

# Map sender addresses to allowed login usernames
smtpd_sender_login_maps = proxy:pgsql:/etc/postfix/sql/sender_login.cf

# =============================================================================
# Relay Restrictions
# =============================================================================

# Port 25 (from edge relay - IP trusted)
smtpd_relay_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination

smtpd_recipient_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_unknown_recipient_domain

smtpd_sender_restrictions =
    reject_unknown_sender_domain

smtpd_helo_required = yes
smtpd_helo_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_invalid_helo_hostname

# =============================================================================
# DKIM via OpenDKIM
# =============================================================================

{% if mail_backend_dkim_enabled %}
# Milter configuration for OpenDKIM
# Path is relative to chroot (/var/spool/postfix/)
milter_protocol = 6
milter_default_action = accept
smtpd_milters = unix:opendkim/opendkim.sock
non_smtpd_milters = unix:opendkim/opendkim.sock
{% endif %}

# =============================================================================
# Plus Addressing
# =============================================================================

recipient_delimiter = {{ mail_backend_recipient_delimiter }}

# =============================================================================
# Misc Settings
# =============================================================================

# Message size limit (50MB)
message_size_limit = 52428800

# Mailbox size limit (0 = unlimited)
mailbox_size_limit = 0

# Queue settings
maximal_queue_lifetime = 5d
bounce_queue_lifetime = 5d

# SMTPUTF8 support (disabled by default; local LMTP path is ASCII/punycode only)
smtputf8_enable = {{ 'yes' if mail_backend_smtputf8_enable else 'no' }}

# Logging
maillog_file = {{ mail_backend_maillog_file }}

# Compatibility
compatibility_level = 3.6

# Disable local aliases (using virtual only)
alias_maps =
alias_database =
