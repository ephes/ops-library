# Dovecot SQL authentication configuration
# Generated by Ansible - do not edit manually
# Role: mail_backend_deploy
# Schema mode: {{ mail_backend_schema_mode }}

driver = pgsql
connect = host={{ mail_backend_postgres_host }} dbname={{ mail_backend_postgres_database }} user={{ mail_backend_postgres_user }} password={{ mail_backend_postgres_password }}

default_pass_scheme = {{ mail_backend_password_scheme }}

{% if mail_backend_schema_mode == 'postfixadmin' %}
# PostfixAdmin schema queries

# Password query - authenticate user
password_query = \
  SELECT username AS user, password \
  FROM mailbox \
  WHERE LOWER(username) = LOWER('%u') AND active = '1'

# User query - get maildir location
user_query = \
  SELECT \
    '{{ mail_backend_vmail_path }}/' || maildir AS home, \
    'maildir:{{ mail_backend_vmail_path }}/' || maildir AS mail, \
    {{ mail_backend_vmail_uid }} AS uid, \
    {{ mail_backend_vmail_gid }} AS gid \
  FROM mailbox \
  WHERE LOWER(username) = LOWER('%u') AND active = '1'

# Iterate query - list all users (for doveadm operations)
iterate_query = SELECT username AS user FROM mailbox WHERE active = '1'

{% else %}
# Legacy schema queries (mail_* tables)

# Password query - authenticate user
password_query = \
  SELECT email AS user, password \
  FROM mail_users_view \
  WHERE LOWER(email) = LOWER('%u')

# User query - get maildir location
user_query = \
  SELECT \
    '{{ mail_backend_vmail_path }}/' || maildir AS home, \
    'maildir:{{ mail_backend_vmail_path }}/' || maildir AS mail, \
    {{ mail_backend_vmail_uid }} AS uid, \
    {{ mail_backend_vmail_gid }} AS gid \
  FROM mail_users_view \
  WHERE LOWER(email) = LOWER('%u')

# Iterate query - list all users (for doveadm operations)
iterate_query = SELECT email AS user FROM mail_users_view
{% endif %}
