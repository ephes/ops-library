---
# mail_backend_deploy - Main task orchestration

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - mail_backend_domains is defined
      - mail_backend_domains | length > 0
      - mail_backend_postgres_password is defined
      - mail_backend_postgres_password | length > 0
      - mail_backend_relay_host is defined
      - mail_backend_relay_password is defined
    fail_msg: |
      Required variables not set:
      - mail_backend_domains: List of domains to host
      - mail_backend_postgres_password: PostgreSQL password for mail user
      - mail_backend_relay_host: Edge relay for outbound mail
      - mail_backend_relay_password: Password for SMTP AUTH to edge

- name: Install mail backend packages
  ansible.builtin.import_tasks: packages.yml

- name: Create vmail user and directories
  ansible.builtin.import_tasks: vmail.yml

- name: Set up PostgreSQL database and schema
  ansible.builtin.import_tasks: database.yml

- name: Configure Postfix
  ansible.builtin.import_tasks: postfix.yml

- name: Configure Dovecot
  ansible.builtin.import_tasks: dovecot.yml

- name: Configure DKIM
  ansible.builtin.import_tasks: dkim.yml
  when: mail_backend_dkim_enabled

- name: Configure services
  ansible.builtin.import_tasks: services.yml
