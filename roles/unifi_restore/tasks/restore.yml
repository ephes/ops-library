---
- name: Stop UniFi service
  ansible.builtin.systemd:
    name: "{{ unifi_service_name }}"
    state: stopped

- name: Wait for clean shutdown
  ansible.builtin.pause:
    seconds: "{{ unifi_restore_service_stop_pause | int }}"

- block:
    - name: "mongodb | Determine backup dump directory"
      ansible.builtin.set_fact:
        unifi_restore_mongodb_dump_dir: "{{ unifi_restore_extracted_dir }}/database/{{ unifi_restore_mongodb_database }}"

    - name: "mongodb | Check for MongoDB dump directory"
      ansible.builtin.stat:
        path: "{{ unifi_restore_mongodb_dump_dir }}"
      register: unifi_restore_mongodb_dump_stat

    - name: "mongodb | Set MongoDB dump availability fact"
      ansible.builtin.set_fact:
        unifi_restore_mongodb_dump_available: "{{ unifi_restore_mongodb_dump_stat.stat.exists | default(false) and unifi_restore_mongodb_dump_stat.stat.isdir | default(false) }}"

    - name: "mongodb | Warn if MongoDB dump is missing"
      ansible.builtin.debug:
        msg: >-
          MongoDB dump not found at {{ unifi_restore_mongodb_dump_dir }}.
          Backup was likely created without MongoDB dump. Skipping MongoDB restore.
      when: not unifi_restore_mongodb_dump_available

    - name: "mongodb | Build drop database command"
      ansible.builtin.set_fact:
        unifi_restore_mongodb_drop_args: >-
          {{
            [
              unifi_mongodb_shell_binary,
              '--host=' ~ unifi_restore_mongodb_host,
              '--port=' ~ (unifi_restore_mongodb_port | string),
              '--quiet',
              '--eval=db.getSiblingDB("' ~ unifi_restore_mongodb_database ~ '").dropDatabase()'
            ]
            + (((unifi_restore_mongodb_username | default('', true) | length) > 0)
                | ternary(['--username=' ~ unifi_restore_mongodb_username], []))
            + (((unifi_restore_mongodb_password | default('', true) | length) > 0)
                | ternary(['--password=' ~ unifi_restore_mongodb_password], []))
            + (((unifi_restore_mongodb_auth_db | default('', true) | length) > 0)
                | ternary(['--authenticationDatabase=' ~ unifi_restore_mongodb_auth_db], []))
          }}
      when:
        - unifi_restore_mongodb_dump_available
        - unifi_restore_mongodb_drop_database | bool
      no_log: "{{ unifi_restore_mongodb_password | default('', true) | length > 0 }}"

    - name: "mongodb | Drop existing MongoDB database"
      ansible.builtin.command:
        argv: "{{ unifi_restore_mongodb_drop_args }}"
      register: unifi_restore_mongodb_drop_result
      changed_when: true
      when:
        - unifi_restore_mongodb_dump_available
        - unifi_restore_mongodb_drop_database | bool
      no_log: "{{ unifi_restore_mongodb_password | default('', true) | length > 0 }}"

    - name: "mongodb | Build mongorestore command arguments"
      ansible.builtin.set_fact:
        unifi_restore_mongorestore_args: >-
          {{
            [
              unifi_mongodb_restore_binary,
              '--host=' ~ unifi_restore_mongodb_host,
              '--port=' ~ (unifi_restore_mongodb_port | string),
              '--db=' ~ unifi_restore_mongodb_database,
              '--dir=' ~ unifi_restore_mongodb_dump_dir
            ]
            + (((unifi_restore_mongodb_username | default('', true) | length) > 0)
                | ternary(['--username=' ~ unifi_restore_mongodb_username], []))
            + (((unifi_restore_mongodb_password | default('', true) | length) > 0)
                | ternary(['--password=' ~ unifi_restore_mongodb_password], []))
            + (((unifi_restore_mongodb_auth_db | default('', true) | length) > 0)
                | ternary(['--authenticationDatabase=' ~ unifi_restore_mongodb_auth_db], []))
            + ((unifi_restore_use_mongorestore_drop_flag | bool)
                | ternary(['--drop'], []))
          }}
      when: unifi_restore_mongodb_dump_available
      no_log: "{{ unifi_restore_mongodb_password | default('', true) | length > 0 }}"

    - name: "mongodb | Restore MongoDB database"
      ansible.builtin.command:
        argv: "{{ unifi_restore_mongorestore_args }}"
      register: unifi_restore_mongorestore_result
      changed_when: true
      retries: 3
      delay: 5
      until: unifi_restore_mongorestore_result.rc == 0
      when: unifi_restore_mongodb_dump_available
      no_log: "{{ unifi_restore_mongodb_password | default('', true) | length > 0 }}"

  when: unifi_restore_include_mongodb | bool

# Automated restore path: rsync data directory
- block:
    - name: Rsync UniFi data directory
      ansible.builtin.command:
        cmd: >
          {{ unifi_restore_rsync_binary }} -a --delete
          "{{ unifi_restore_extracted_dir }}/data/"
          "{{ unifi_data_path }}/"
      changed_when: true

    - name: Ensure data directory ownership
      ansible.builtin.command: |
        find "{{ unifi_data_path }}" -exec chown unifi:unifi {} +
      changed_when: true
  when: unifi_restore_method == 'automated'

# Manual .unf preparation path
- block:
    - name: Find latest .unf file in backup
      ansible.builtin.find:
        paths: "{{ unifi_restore_extracted_dir }}/autobackups"
        patterns: "*.unf"
      register: unifi_restore_unf_files

    - name: Ensure a .unf file exists for manual restore
      ansible.builtin.fail:
        msg: "No .unf backups were found inside the selected archive."
      when: unifi_restore_unf_files.matched | default(0) | int == 0

    - name: Copy latest .unf to /tmp/unifi-restore.unf
      ansible.builtin.copy:
        src: "{{ (unifi_restore_unf_files.files | sort(attribute='mtime') | last).path }}"
        dest: "/tmp/unifi-restore.unf"
        mode: "0644"
        remote_src: true

    - name: Display manual restore instructions
      ansible.builtin.debug:
        msg: |
          .unf file extracted to /tmp/unifi-restore.unf

          To complete restore:
          1. Start UniFi service
          2. Open web UI: {{ unifi_restore_health_url }}
          3. Navigate to Settings > System > Backup
          4. Click "Restore from Backup"
          5. Upload /tmp/unifi-restore.unf
          6. Follow the web UI prompts
          (File is removed automatically during cleanup; download it now if you need a local copy.)
  when: unifi_restore_method == 'manual-unf-prep'

- name: Stat extracted systemd unit
  ansible.builtin.stat:
    path: "{{ unifi_restore_extracted_dir }}/systemd/unifi.service"
  register: unifi_restore_systemd_stat

- name: Restore systemd unit file
  ansible.builtin.copy:
    src: "{{ unifi_restore_extracted_dir }}/systemd/unifi.service"
    dest: /etc/systemd/system/unifi.service
    remote_src: true
  when: unifi_restore_systemd_stat.stat.exists

- name: Stat extracted Traefik config
  ansible.builtin.stat:
    path: "{{ unifi_restore_extracted_dir }}/traefik/unifi.yml"
  register: unifi_restore_traefik_stat

- name: Restore Traefik dynamic config
  ansible.builtin.copy:
    src: "{{ unifi_restore_extracted_dir }}/traefik/unifi.yml"
    dest: /etc/traefik/dynamic/unifi.yml
    remote_src: true
  when: unifi_restore_traefik_stat.stat.exists

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Start UniFi service
  ansible.builtin.systemd:
    name: "{{ unifi_service_name }}"
    state: started
