---
# minecraft_java_deploy - Install and configure Forge runtime

- name: Select Forge installer checksum algorithm
  ansible.builtin.set_fact:
    minecraft_java_forge_installer_checksum: >-
      {{
        'sha256:' ~ minecraft_java_forge_installer_sha256
        if (minecraft_java_forge_installer_sha256 != 'CHANGEME' and minecraft_java_forge_installer_sha256 | length >= 64)
        else 'sha1:' ~ minecraft_java_forge_installer_sha1
      }}

- name: Check Forge version marker
  ansible.builtin.stat:
    path: "{{ minecraft_java_forge_version_marker_path }}"
  register: minecraft_java_forge_version_marker_stat

- name: Check Forge checksum marker
  ansible.builtin.stat:
    path: "{{ minecraft_java_forge_checksum_marker_path }}"
  register: minecraft_java_forge_checksum_marker_stat

- name: Check Forge unix args file
  ansible.builtin.stat:
    path: "{{ minecraft_java_forge_unix_args_path }}"
  register: minecraft_java_forge_unix_args_stat

- name: Check Forge run.sh generated by installer
  ansible.builtin.stat:
    path: "{{ minecraft_java_server_dir }}/run.sh"
  register: minecraft_java_forge_run_sh_stat

- name: Default installed Forge marker values
  ansible.builtin.set_fact:
    minecraft_java_installed_forge_version: ""
    minecraft_java_installed_forge_checksum: ""

- name: Read Forge version marker
  ansible.builtin.slurp:
    path: "{{ minecraft_java_forge_version_marker_path }}"
  register: minecraft_java_forge_version_marker_content
  when: minecraft_java_forge_version_marker_stat.stat.exists

- name: Set installed Forge version from marker
  ansible.builtin.set_fact:
    minecraft_java_installed_forge_version: "{{ minecraft_java_forge_version_marker_content.content | b64decode | trim }}"
  when: minecraft_java_forge_version_marker_stat.stat.exists

- name: Read Forge checksum marker
  ansible.builtin.slurp:
    path: "{{ minecraft_java_forge_checksum_marker_path }}"
  register: minecraft_java_forge_checksum_marker_content
  when: minecraft_java_forge_checksum_marker_stat.stat.exists

- name: Set installed Forge checksum marker value
  ansible.builtin.set_fact:
    minecraft_java_installed_forge_checksum: "{{ minecraft_java_forge_checksum_marker_content.content | b64decode | trim }}"
  when: minecraft_java_forge_checksum_marker_stat.stat.exists

- name: Determine whether Forge installer must be executed
  ansible.builtin.set_fact:
    minecraft_java_forge_install_required: >-
      {{
        (not minecraft_java_forge_version_marker_stat.stat.exists)
        or (not minecraft_java_forge_checksum_marker_stat.stat.exists)
        or (not minecraft_java_forge_unix_args_stat.stat.exists)
        or (not minecraft_java_forge_run_sh_stat.stat.exists)
        or (minecraft_java_installed_forge_version != minecraft_java_forge_version)
        or (minecraft_java_installed_forge_checksum != minecraft_java_forge_installer_checksum)
      }}

- name: Download Forge installer
  ansible.builtin.get_url:
    url: "{{ minecraft_java_forge_installer_url }}"
    dest: "{{ minecraft_java_forge_installer_path }}"
    checksum: "{{ minecraft_java_forge_installer_checksum }}"
    owner: "{{ minecraft_java_user }}"
    group: "{{ minecraft_java_group }}"
    mode: "0644"
    timeout: 300
  when: minecraft_java_forge_install_required

- name: Run Forge installer (--installServer)
  ansible.builtin.command:
    cmd: "/usr/bin/java -jar {{ minecraft_java_forge_installer_path }} --installServer"
    chdir: "{{ minecraft_java_forge_install_dir }}"
  become: true
  become_user: "{{ minecraft_java_user }}"
  register: minecraft_java_forge_install_cmd
  changed_when: true
  when: minecraft_java_forge_install_required
  notify: restart minecraft-java

- name: Ensure generated run.sh has execute permissions
  ansible.builtin.file:
    path: "{{ minecraft_java_server_dir }}/run.sh"
    owner: "{{ minecraft_java_user }}"
    group: "{{ minecraft_java_group }}"
    mode: "0755"
  when: minecraft_java_forge_install_required

- name: Persist Forge version marker
  ansible.builtin.copy:
    content: "{{ minecraft_java_forge_version }}\n"
    dest: "{{ minecraft_java_forge_version_marker_path }}"
    owner: "{{ minecraft_java_user }}"
    group: "{{ minecraft_java_group }}"
    mode: "0644"
  when: minecraft_java_forge_install_required

- name: Persist Forge installer checksum marker
  ansible.builtin.copy:
    content: "{{ minecraft_java_forge_installer_checksum }}\n"
    dest: "{{ minecraft_java_forge_checksum_marker_path }}"
    owner: "{{ minecraft_java_user }}"
    group: "{{ minecraft_java_group }}"
    mode: "0644"
  when: minecraft_java_forge_install_required

- name: Verify Forge unix args file exists
  ansible.builtin.stat:
    path: "{{ minecraft_java_forge_unix_args_path }}"
  register: minecraft_java_forge_unix_args_verify

- name: Verify Forge run.sh exists
  ansible.builtin.stat:
    path: "{{ minecraft_java_server_dir }}/run.sh"
  register: minecraft_java_forge_run_sh_verify

- name: Assert Forge runtime artifacts are present
  ansible.builtin.assert:
    that:
      - minecraft_java_forge_unix_args_verify.stat.exists
      - minecraft_java_forge_run_sh_verify.stat.exists
    fail_msg: |
      Forge runtime artifacts are missing after install.
      Expected:
      - {{ minecraft_java_forge_unix_args_path }}
      - {{ minecraft_java_server_dir }}/run.sh

      Ensure the host has outbound internet access (Mojang + Maven mirrors) and retry.

- name: Manage Forge JVM args file
  ansible.builtin.template:
    src: user_jvm_args.txt.j2
    dest: "{{ minecraft_java_forge_user_jvm_args_path }}"
    owner: "{{ minecraft_java_user }}"
    group: "{{ minecraft_java_group }}"
    mode: "0644"
  notify: restart minecraft-java

- name: Manage Forge startup wrapper
  ansible.builtin.template:
    src: start-forge.sh.j2
    dest: "{{ minecraft_java_forge_wrapper_script_path }}"
    owner: "{{ minecraft_java_user }}"
    group: "{{ minecraft_java_group }}"
    mode: "0755"
  notify: restart minecraft-java
