---
# Setup scheduled backup and cleanup cron jobs for Echoport

- name: scheduler | Setup scheduled backup cron job
  ansible.builtin.cron:
    name: "Echoport scheduled backups"
    minute: "{{ echoport_scheduler_interval }}"
    hour: "*"
    job: >-
      cd {{ echoport_site_path }} &&
      DJANGO_SETTINGS_MODULE={{ echoport_django_settings_module }}
      {{ echoport_venv_bin }}/python manage.py run_scheduled_backups
      >> {{ echoport_home }}/logs/scheduler.log 2>&1
    user: "{{ echoport_user }}"
    state: "{{ 'present' if echoport_scheduler_enabled else 'absent' }}"

- name: scheduler | Create scheduler log file
  ansible.builtin.file:
    path: "{{ echoport_home }}/logs/scheduler.log"
    state: touch
    owner: "{{ echoport_user }}"
    group: "{{ echoport_group }}"
    mode: "0640"
    modification_time: preserve
    access_time: preserve
  when: echoport_scheduler_enabled

- name: scheduler | Setup cleanup cron job
  ansible.builtin.cron:
    name: "Echoport cleanup old backups"
    minute: "0"
    hour: "{{ echoport_cleanup_hour }}"
    job: >-
      cd {{ echoport_site_path }} &&
      DJANGO_SETTINGS_MODULE={{ echoport_django_settings_module }}
      {{ echoport_venv_bin }}/python manage.py cleanup_old_backups
      >> {{ echoport_home }}/logs/cleanup.log 2>&1
    user: "{{ echoport_user }}"
    state: "{{ 'present' if echoport_cleanup_enabled else 'absent' }}"

- name: scheduler | Create cleanup log file
  ansible.builtin.file:
    path: "{{ echoport_home }}/logs/cleanup.log"
    state: touch
    owner: "{{ echoport_user }}"
    group: "{{ echoport_group }}"
    mode: "0640"
    modification_time: preserve
    access_time: preserve
  when: echoport_cleanup_enabled

- name: scheduler | Deploy staging DB refresh helper script
  ansible.builtin.template:
    src: staging-db-refresh.sh.j2
    dest: "{{ echoport_site_path }}/staging-db-refresh.sh"
    owner: "{{ echoport_user }}"
    group: "{{ echoport_group }}"
    mode: "0750"
  when:
    - echoport_staging_db_refresh_enabled
    - echoport_staging_db_refresh_targets | length > 0

- name: scheduler | Setup staging DB refresh cron job
  ansible.builtin.cron:
    name: "Echoport staging DB refresh"
    minute: "{{ echoport_staging_db_refresh_minute }}"
    hour: "{{ echoport_staging_db_refresh_hour }}"
    job: >-
      cd {{ echoport_site_path }} &&
      {{ echoport_site_path }}/staging-db-refresh.sh
      >> {{ echoport_home }}/logs/staging-db-refresh.log 2>&1
    user: "{{ echoport_user }}"
    state: "{{ 'present' if (echoport_staging_db_refresh_enabled and (echoport_staging_db_refresh_targets | length > 0)) else 'absent' }}"

- name: scheduler | Create staging DB refresh log file
  ansible.builtin.file:
    path: "{{ echoport_home }}/logs/staging-db-refresh.log"
    state: touch
    owner: "{{ echoport_user }}"
    group: "{{ echoport_group }}"
    mode: "0640"
    modification_time: preserve
    access_time: preserve
  when:
    - echoport_staging_db_refresh_enabled
    - echoport_staging_db_refresh_targets | length > 0
