---
- name: Validate schema mode
  ansible.builtin.assert:
    that:
      - mail_users_schema_mode in ['postfixadmin', 'legacy']
    fail_msg: "mail_users_schema_mode must be 'postfixadmin' or 'legacy'"

- name: Get existing mail users from database (PostfixAdmin)
  community.postgresql.postgresql_query:
    db: "{{ mail_users_postgres_database }}"
    query: |
      SELECT LOWER(username) AS email, active
      FROM mailbox
  register: existing_users
  become: true
  become_user: postgres
  when: mail_users_schema_mode == 'postfixadmin'

- name: Get existing mail users from database (legacy)
  community.postgresql.postgresql_query:
    db: "{{ mail_users_postgres_database }}"
    query: |
      SELECT LOWER(u.localpart || '@' || d.name) AS email, u.active
      FROM mail_users u
      JOIN mail_domains d ON u.domain_id = d.id
  register: existing_users
  become: true
  become_user: postgres
  when: mail_users_schema_mode == 'legacy'

- name: Build list of existing emails
  ansible.builtin.set_fact:
    existing_user_rows: >-
      {{
        existing_users.query_result
        if (existing_users.query_result is defined)
        else
        (
          (existing_users.query_all_results | first)
          if (
            existing_users.query_all_results is defined
            and (existing_users.query_all_results | length > 0)
          )
          else []
        )
      }}

- name: Build list of existing emails
  ansible.builtin.set_fact:
    existing_emails: "{{ existing_user_rows | map(attribute='email') | map('lower') | list }}"

- name: Create or update mail users
  ansible.builtin.include_tasks: sync_user.yml
  loop: "{{ mail_users_list }}"
  loop_control:
    loop_var: user

- name: Disable users not in secrets (optional - PostfixAdmin)
  community.postgresql.postgresql_query:
    db: "{{ mail_users_postgres_database }}"
    query: |
      UPDATE mailbox
      SET active = '0', modified = NOW()
      WHERE LOWER(username) = LOWER(%(email)s)
        AND active = '1'
    named_args:
      email: "{{ item }}"
  loop: "{{ existing_emails | difference(mail_users_list | map(attribute='email') | map('lower') | list) }}"
  become: true
  become_user: postgres
  when:
    - mail_users_disable_unlisted | default(false)
    - mail_users_schema_mode == 'postfixadmin'

- name: Disable users not in secrets (optional - legacy)
  community.postgresql.postgresql_query:
    db: "{{ mail_users_postgres_database }}"
    query: |
      UPDATE mail_users u
      SET active = false
      FROM mail_domains d
      WHERE u.domain_id = d.id
        AND LOWER(u.localpart || '@' || d.name) = LOWER(%(email)s)
        AND u.active = true
    named_args:
      email: "{{ item }}"
  loop: "{{ existing_emails | difference(mail_users_list | map(attribute='email') | map('lower') | list) }}"
  become: true
  become_user: postgres
  when:
    - mail_users_disable_unlisted | default(false)
    - mail_users_schema_mode == 'legacy'
