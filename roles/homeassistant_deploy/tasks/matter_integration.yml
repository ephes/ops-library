---
- name: "Initialize Matter integration state"
  ansible.builtin.set_fact:
    _ha_matter_entry_url: ""

- name: "Check Home Assistant config entries storage"
  ansible.builtin.stat:
    path: "{{ homeassistant_config_path }}/.storage/core.config_entries"
  register: _ha_config_entries_stat

- name: "Read Home Assistant config entries storage"
  ansible.builtin.slurp:
    path: "{{ homeassistant_config_path }}/.storage/core.config_entries"
  register: _ha_config_entries_raw
  when: _ha_config_entries_stat.stat.exists

- name: "Extract existing Matter integration URL"
  ansible.builtin.set_fact:
    _ha_matter_entry_url: >-
      {{
        (
          (
            ((_ha_config_entries_raw.content | b64decode | from_json).data | default({}, true)).entries
            | default([], true)
          )
          | selectattr('domain', 'equalto', 'matter')
          | selectattr('data.url', 'defined')
          | map(attribute='data.url')
          | list
          | first
        ) | default('', true)
      }}
  when: _ha_config_entries_stat.stat.exists

- name: "Determine if Matter integration provisioning is needed"
  ansible.builtin.set_fact:
    _ha_matter_integration_needs_config: "{{ _ha_matter_entry_url != homeassistant_matter_integration_url }}"

- name: "Default Home Assistant API forwarded address"
  ansible.builtin.set_fact:
    homeassistant_api_forwarded_for: "{{ ansible_default_ipv4.address | default('127.0.0.1') }}"
  when: (homeassistant_api_forwarded_for | default('')) | length == 0

- name: "Provision Matter integration via Home Assistant API"
  when:
    - _ha_matter_integration_needs_config | bool
    - not ansible_check_mode
  block:
    - name: "Wait for Home Assistant API"
      ansible.builtin.uri:
        url: "{{ homeassistant_api_url }}/api/"
        method: GET
        status_code: 200
        headers:
          Authorization: "Bearer {{ homeassistant_api_token }}"
          X-Forwarded-For: "{{ homeassistant_api_forwarded_for }}"
          X-Forwarded-Proto: "{{ homeassistant_api_forwarded_proto }}"
        validate_certs: "{{ homeassistant_api_validate_certs | bool }}"
        timeout: "{{ homeassistant_api_timeout }}"
      register: _ha_api_ready
      retries: "{{ homeassistant_api_retries }}"
      delay: "{{ homeassistant_api_retry_delay }}"
      until: _ha_api_ready.status == 200
      no_log: true

    - name: "Wait for Matter server port"
      ansible.builtin.wait_for:
        host: "127.0.0.1"
        port: "{{ homeassistant_matter_server_port }}"
        timeout: "{{ homeassistant_api_timeout }}"
      when: homeassistant_manage_matter_server | bool

    - name: "Start Matter config flow"
      ansible.builtin.uri:
        url: "{{ homeassistant_api_url }}/api/config/config_entries/flow"
        method: POST
        headers:
          Authorization: "Bearer {{ homeassistant_api_token }}"
          Content-Type: "application/json"
          X-Forwarded-For: "{{ homeassistant_api_forwarded_for }}"
          X-Forwarded-Proto: "{{ homeassistant_api_forwarded_proto }}"
        body_format: json
        body:
          handler: matter
        return_content: true
        status_code: 200
        validate_certs: "{{ homeassistant_api_validate_certs | bool }}"
        timeout: "{{ homeassistant_api_timeout }}"
      register: _ha_matter_flow
      no_log: true

    - name: "Submit Matter config flow"
      ansible.builtin.uri:
        url: "{{ homeassistant_api_url }}/api/config/config_entries/flow/{{ _ha_matter_flow.json.flow_id }}"
        method: POST
        headers:
          Authorization: "Bearer {{ homeassistant_api_token }}"
          Content-Type: "application/json"
          X-Forwarded-For: "{{ homeassistant_api_forwarded_for }}"
          X-Forwarded-Proto: "{{ homeassistant_api_forwarded_proto }}"
        body_format: json
        body:
          url: "{{ homeassistant_matter_integration_url }}"
        return_content: true
        status_code: 200
        validate_certs: "{{ homeassistant_api_validate_certs | bool }}"
        timeout: "{{ homeassistant_api_timeout }}"
      register: _ha_matter_flow_result
      no_log: true
      when: _ha_matter_flow.json.flow_id is defined

    - name: "Fail when Matter config flow does not complete"
      ansible.builtin.fail:
        msg: "Matter config flow did not complete; verify the Matter server is reachable and the API token is valid."
      when:
        - _ha_matter_flow_result is defined
        - (_ha_matter_flow_result.json.type | default('')) == 'form'
