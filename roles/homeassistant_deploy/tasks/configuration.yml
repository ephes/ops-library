- name: "Template secrets.yaml"
  ansible.builtin.template:
    src: secrets.yaml.j2
    dest: "{{ homeassistant_config_path }}/secrets.yaml"
    owner: "{{ homeassistant_user }}"
    group: "{{ homeassistant_group }}"
    mode: "0600"
    backup: true
  when: homeassistant_manage_secrets | bool

- name: "Check existing configuration file"
  ansible.builtin.stat:
    path: "{{ homeassistant_config_path }}/configuration.yaml"
  register: _ha_configuration_stat

- name: "Template configuration.yaml"
  ansible.builtin.template:
    src: configuration.yaml.j2
    dest: "{{ homeassistant_config_path }}/configuration.yaml"
    owner: "{{ homeassistant_user }}"
    group: "{{ homeassistant_group }}"
    mode: "0644"
    backup: true
  when:
    - homeassistant_manage_configuration | bool
    - homeassistant_overwrite_config | bool or not _ha_configuration_stat.stat.exists

- name: "Check include files"
  ansible.builtin.stat:
    path: "{{ homeassistant_config_path }}/{{ item }}"
  loop: "{{ homeassistant_include_files }}"
  register: _ha_include_stats
  when: homeassistant_manage_includes | bool

- name: "Build include map"
  ansible.builtin.set_fact:
    _ha_include_exists: "{{ _ha_include_exists | default({}) | combine({ item.item: item.stat.exists }) }}"
  loop: "{{ _ha_include_stats.results | default([]) }}"
  when: homeassistant_manage_includes | bool

- name: "Manage include files"
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ homeassistant_config_path }}/{{ item }}"
    owner: "{{ homeassistant_user }}"
    group: "{{ homeassistant_group }}"
    mode: "0644"
    backup: true
    force: "{{ homeassistant_overwrite_config | bool }}"
  loop: "{{ homeassistant_include_files }}"
  when:
    - homeassistant_manage_includes | bool
    - homeassistant_overwrite_config | bool or not (_ha_include_exists[item] | default(false))
