---
- name: "Initialize UniFi password fact"
  ansible.builtin.set_fact:
    homeassistant_unifi_password_effective: "{{ homeassistant_unifi_password | default('', true) }}"

- name: "Read UniFi password from file"
  ansible.builtin.slurp:
    src: "{{ homeassistant_unifi_password_file }}"
  register: _ha_unifi_password_file
  when:
    - homeassistant_unifi_password_effective | length == 0
    - homeassistant_unifi_password_source == 'file'
  failed_when: false

- name: "Use UniFi password from file content"
  ansible.builtin.set_fact:
    homeassistant_unifi_password_effective: "{{ _ha_unifi_password_file.content | b64decode | trim }}"
  when:
    - _ha_unifi_password_file is defined
    - _ha_unifi_password_file.content is defined
    - _ha_unifi_password_file.content | length > 0

- name: "Generate UniFi password fallback"
  ansible.builtin.set_fact:
    homeassistant_unifi_password_effective: "{{ lookup('password', '/tmp/homeassistant_unifi_password length=' ~ homeassistant_unifi_password_length ~ ' chars=' ~ homeassistant_unifi_password_charset) }}"
  when:
    - homeassistant_unifi_password_effective | length == 0
    - homeassistant_manage_unifi_password | bool

- name: "Use variable-supplied UniFi password"
  ansible.builtin.set_fact:
    homeassistant_unifi_password_effective: "{{ homeassistant_unifi_password_variable }}"
  when:
    - homeassistant_unifi_password_effective | length == 0
    - homeassistant_unifi_password_source == 'variable'
    - homeassistant_unifi_password_variable | length > 0

- name: "Fail if UniFi password is still undefined"
  ansible.builtin.fail:
    msg: "UniFi password not provided. Set homeassistant_unifi_password or enable file/generate sources."
  when:
    - homeassistant_unifi_password_effective | default('', true) | length == 0
    - homeassistant_manage_secrets | bool
