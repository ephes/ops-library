---
- name: Validate static IP configuration
  ansible.builtin.assert:
    that:
      - remote_luks_unlock_static_ip | length > 0
      - remote_luks_unlock_static_gateway | length > 0
      - remote_luks_unlock_static_netmask | length > 0
    fail_msg: |
      Static IP mode requires:
      - remote_luks_unlock_static_ip (currently: "{{ remote_luks_unlock_static_ip }}")
      - remote_luks_unlock_static_gateway (currently: "{{ remote_luks_unlock_static_gateway }}")
      - remote_luks_unlock_static_netmask (currently: "{{ remote_luks_unlock_static_netmask }}")
    quiet: false
  when: remote_luks_unlock_ip_mode == "static"

- name: Read current GRUB_CMDLINE_LINUX_DEFAULT
  ansible.builtin.command: |
    python3 - <<'PY'
    import shlex
    value = ""
    try:
        with open("/etc/default/grub", "r", encoding="utf-8") as fh:
            for line in fh:
                if line.startswith("GRUB_CMDLINE_LINUX_DEFAULT="):
                    raw = line.split("=", 1)[1].strip()
                    try:
                        value = " ".join(shlex.split(raw, posix=True))
                    except ValueError:
                        # Fall back to minimal stripping if the line is malformed
                        value = raw.strip()
                        if value and value[0] in ("'", '"') and value[-1] == value[0]:
                            value = value[1:-1]
                    break
    except FileNotFoundError:
        pass

    print(value)
    PY
  register: _current_grub_cmdline
  changed_when: false
  failed_when: false

- name: Build ip= parameter for DHCP
  ansible.builtin.set_fact:
    _ip_param: ":::::{{ remote_luks_unlock_interface }}:dhcp"
  when: remote_luks_unlock_ip_mode == "dhcp"

- name: Build ip= parameter for static
  ansible.builtin.set_fact:
    _ip_param: "{{ remote_luks_unlock_static_ip }}::{{ remote_luks_unlock_static_gateway }}:{{ remote_luks_unlock_static_netmask }}:{{ remote_luks_unlock_static_hostname }}:{{ remote_luks_unlock_interface }}:none"
  when: remote_luks_unlock_ip_mode == "static"

- name: Parse current cmdline and remove existing ip= parameter
  ansible.builtin.set_fact:
    _current_tokens: "{{ (_current_grub_cmdline.stdout | default('')).split() }}"

- name: Normalize current GRUB cmdline
  ansible.builtin.set_fact:
    _normalized_current_grub_cmdline: "{{ _current_tokens | join(' ') }}"

- name: Remove existing ip= parameter from tokens (scoped to our interface)
  ansible.builtin.set_fact:
    _filtered_tokens: >-
      {{
        _current_tokens |
        reject('search', 'ip=.*:' + remote_luks_unlock_interface + ':') |
        list
      }}
  when: not (remote_luks_unlock_force_remove_all_network_config | bool)

- name: Remove ALL ip= parameters (force mode)
  ansible.builtin.set_fact:
    _filtered_tokens: "{{ _current_tokens | reject('match', '^ip=') | list }}"
  when: remote_luks_unlock_force_remove_all_network_config | bool

- name: Check for other ip= parameters (kernel precedence warning)
  ansible.builtin.set_fact:
    _has_other_ip_params: "{{ _filtered_tokens | select('match', '^ip=') | list | length > 0 }}"

- name: Warn about kernel ip= precedence
  ansible.builtin.debug:
    msg: |
      WARNING: Other ip= parameters detected in GRUB cmdline.
      Many kernels only honor the FIRST ip= parameter, which means our ip= may be ignored.
      Current ip= parameters: {{ _filtered_tokens | select('match', '^ip=') | list }}
      Our parameter will be added: ip={{ _ip_param }}
      If networking doesn't work in initramfs, set remote_luks_unlock_force_remove_all_network_config: true
      (but only if you're certain other ip= parameters are not needed for NFS/iSCSI/PXE).
  when:
    - not (remote_luks_unlock_force_remove_all_network_config | bool)
    - _has_other_ip_params | bool

- name: Build new token list with our ip= parameter
  ansible.builtin.set_fact:
    _new_tokens: "{{ _filtered_tokens + ['ip=' + _ip_param] }}"

- name: Build new GRUB cmdline
  ansible.builtin.set_fact:
    _new_grub_cmdline: "{{ _new_tokens | join(' ') }}"

- name: Update GRUB_CMDLINE_LINUX_DEFAULT
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="{{ _new_grub_cmdline }}"'
    backup: yes
  notify: update grub
  when: _normalized_current_grub_cmdline != _new_grub_cmdline

- name: Read current DEVICE from initramfs.conf
  ansible.builtin.shell: |
    grep '^DEVICE=' /etc/initramfs-tools/initramfs.conf 2>/dev/null | cut -d= -f2 || echo ""
  register: _current_initramfs_device
  changed_when: false
  failed_when: false
  when: not (remote_luks_unlock_force_remove_all_network_config | bool)

- name: Clean up initramfs.conf networking (scoped to our interface)
  ansible.builtin.lineinfile:
    path: /etc/initramfs-tools/initramfs.conf
    regexp: '^{{ item }}='
    state: absent
  loop:
    - 'DEVICE'
    - 'IP'
  notify: rebuild initramfs
  when:
    - not (remote_luks_unlock_force_remove_all_network_config | bool)
    - _current_initramfs_device.stdout == remote_luks_unlock_interface

- name: Clean up initramfs.conf networking (force - removes all)
  ansible.builtin.lineinfile:
    path: /etc/initramfs-tools/initramfs.conf
    regexp: '^{{ item }}='
    state: absent
  loop:
    - 'DEVICE'
    - 'IP'
  notify: rebuild initramfs
  when: remote_luks_unlock_force_remove_all_network_config | bool
