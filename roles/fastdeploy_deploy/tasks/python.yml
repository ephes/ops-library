---
# Python environment setup for FastDeploy

- name: Check if uv is installed
  stat:
    path: "/usr/local/bin/uv"
  register: uv_installed

- name: Install uv if not present
  shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  when: 
    - fastdeploy_install_uv
    - not uv_installed.stat.exists

- name: Create Python virtual environment with uv
  shell: "/usr/local/bin/uv venv"
  args:
    chdir: "{{ fastdeploy_site_path }}"
    creates: "{{ fastdeploy_venv_path }}"
  become: true
  become_user: "{{ fastdeploy_user }}"

- name: Install Python dependencies with uv
  shell: "/usr/local/bin/uv sync --frozen"
  args:
    chdir: "{{ fastdeploy_site_path }}"
  become: true
  become_user: "{{ fastdeploy_user }}"
  register: uv_sync_result
  changed_when: "'Installing' in uv_sync_result.stdout"