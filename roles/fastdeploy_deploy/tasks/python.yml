---
# Python environment setup for FastDeploy

- name: Ensure uv binary is installed
  ansible.builtin.import_role:
    name: uv_install
  vars:
    uv_install_dir: "{{ fastdeploy_uv_install_dir }}"
  when: fastdeploy_install_uv | bool

- name: Create Python virtual environment with uv
  shell: "{{ fastdeploy_uv_binary }} venv"
  args:
    chdir: "{{ fastdeploy_site_path }}"
    creates: "{{ fastdeploy_venv_path }}"
  become: true
  become_user: "{{ fastdeploy_user }}"

- name: Install Python dependencies with uv
  shell: "{{ fastdeploy_uv_binary }} sync --frozen"
  args:
    chdir: "{{ fastdeploy_site_path }}"
  become: true
  become_user: "{{ fastdeploy_user }}"
  register: uv_sync_result
  changed_when: "'Installing' in uv_sync_result.stdout"