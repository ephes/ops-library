---
# Setup Traefik routing for FastDeploy

- name: Ensure Traefik dynamic directory exists
  file:
    path: /etc/traefik/dynamic
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Install apache2-utils for htpasswd
  package:
    name: apache2-utils
    state: present
  when:
    - ansible_facts['os_family'] == "Debian"
    - fastdeploy_basic_auth_enabled

- name: Generate basic auth password hash
  shell: |
    echo '{{ fastdeploy_basic_auth_password }}' | htpasswd -nBi {{ fastdeploy_basic_auth_user }} | cut -d: -f2
  register: password_hash
  changed_when: false
  no_log: true
  when: fastdeploy_basic_auth_enabled

- name: Set password hash fact
  set_fact:
    fastdeploy_basic_auth_password_hash: "{{ password_hash.stdout }}"
  no_log: true
  when: fastdeploy_basic_auth_enabled

- name: Deploy Traefik configuration
  template:
    src: traefik.yml.j2
    dest: "/etc/traefik/dynamic/{{ fastdeploy_service_name }}.yml"
    owner: root
    group: root
    mode: '0644'
  notify: restart traefik

- name: Ensure Traefik picks up the service
  systemd:
    name: traefik
    state: restarted
  changed_when: false  # Always restart to ensure service is picked up