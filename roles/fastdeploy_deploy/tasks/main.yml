---
# Main tasks for FastDeploy deployment

- name: Validate required variables
  assert:
    that:
      - fastdeploy_deploy_method in ['rsync', 'git']
      - fastdeploy_source_path != "" or fastdeploy_deploy_method == "git"
      - fastdeploy_secret_key is defined
      - fastdeploy_secret_key != ""
      - fastdeploy_secret_key != "CHANGEME"
      - fastdeploy_initial_password_hash is defined
      - fastdeploy_initial_password_hash != ""
      - fastdeploy_initial_password_hash != "CHANGEME"
      - fastdeploy_postgres_password is defined
      - fastdeploy_postgres_password != ""
      - fastdeploy_postgres_password != "CHANGEME"
    fail_msg: |
      SECURITY ERROR: Required secrets are missing or contain placeholder values!

      The following secrets MUST be properly configured:
      - fastdeploy_secret_key: {{ fastdeploy_secret_key | default('NOT SET') | regex_replace('.', '*') }}
      - fastdeploy_initial_password_hash: {{ fastdeploy_initial_password_hash | default('NOT SET') | regex_replace('.', '*') }}
      - fastdeploy_postgres_password: {{ fastdeploy_postgres_password | default('NOT SET') | regex_replace('.', '*') }}

      Placeholder values are NOT allowed in production.
      Please update secrets/prod/fastdeploy.yml with real values.

- name: Setup user and directories
  include_tasks: user.yml

- name: Setup PostgreSQL database
  include_tasks: database.yml

- name: Sync source code (rsync method)
  include_tasks: source_rsync.yml
  when: fastdeploy_deploy_method == 'rsync'

- name: Sync source code (git method)
  include_tasks: source_git.yml
  when: fastdeploy_deploy_method == 'git'

- name: Create environment configuration
  include_tasks: environment.yml

- name: Setup Python environment
  include_tasks: python.yml

- name: Build frontend
  include_tasks: frontend.yml
  when: fastdeploy_build_frontend

- name: Initialize application
  include_tasks: initialize.yml

- name: Setup systemd service
  include_tasks: service.yml

- name: Setup Traefik routing
  include_tasks: traefik.yml
  when: fastdeploy_traefik_enabled