---
- name: rust | Check if rustup is installed
  ansible.builtin.stat:
    path: "{{ vibe_coding_user_home }}/.cargo/bin/rustup"
  register: vibe_coding_rustup_bin

- name: rust | Install rustup
  when: not vibe_coding_rustup_bin.stat.exists
  block:
    - name: rust | Create temporary directory for installer
      ansible.builtin.tempfile:
        state: directory
        prefix: rustup_
      register: vibe_coding_rustup_tmpdir

    - name: rust | Download rustup-init
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: "{{ vibe_coding_rustup_tmpdir.path }}/rustup-init.sh"
        mode: "0755"

    - name: rust | Run rustup-init
      ansible.builtin.command:
        cmd: "{{ vibe_coding_rustup_tmpdir.path }}/rustup-init.sh -y --no-modify-path"
      become: true
      become_user: "{{ vibe_coding_user }}"
      changed_when: true

  always:
    - name: rust | Remove temporary installer directory
      ansible.builtin.file:
        path: "{{ vibe_coding_rustup_tmpdir.path }}"
        state: absent
      when: vibe_coding_rustup_tmpdir is defined

- name: rust | Ensure rust-analyzer is installed
  ansible.builtin.command:
    cmd: "{{ vibe_coding_user_home }}/.cargo/bin/rustup component add rust-analyzer"
  become: true
  become_user: "{{ vibe_coding_user }}"
  register: vibe_coding_rust_analyzer_result
  changed_when: "'installing' in vibe_coding_rust_analyzer_result.stderr"
