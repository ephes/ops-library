---
# Validation and safety checks

- name: Fail if confirmation flag is not set
  ansible.builtin.fail:
    msg: |
      âŒ REMOVAL BLOCKED: homelab_remove_confirm must be set to true

      This role will remove the homelab service and potentially delete data.
      Set homelab_remove_confirm: true to proceed.
  when: not homelab_remove_confirm

- name: Check if systemd service exists
  ansible.builtin.stat:
    path: "{{ homelab_systemd_unit_path }}"
  register: homelab_service_file

- name: Check if user exists
  ansible.builtin.getent:
    database: passwd
    key: "{{ homelab_user }}"
  failed_when: false
  register: homelab_user_check

- name: Check if home directory exists
  ansible.builtin.stat:
    path: "{{ homelab_home }}"
  register: homelab_home_check

- name: Check if database exists
  ansible.builtin.stat:
    path: "{{ homelab_site_path }}/db.sqlite3"
  register: homelab_db_check
  when: homelab_home_check.stat.exists

- name: Check if media directory exists
  ansible.builtin.stat:
    path: "{{ homelab_site_path }}/media"
  register: homelab_media_check
  when: homelab_home_check.stat.exists

- name: Display removal plan
  ansible.builtin.debug:
    msg: |

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ—‘ï¸  HOMELAB REMOVAL PLAN
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      WILL BE REMOVED:
      {% if homelab_service_file.stat.exists %}
      âœ“ Systemd service: {{ homelab_systemd_unit_path }}
      {% else %}
      âœ— Systemd service: Not found (already removed)
      {% endif %}
      {% if homelab_remove_traefik_config %}
      âœ“ Traefik config: {{ homelab_traefik_config_path }}
      {% else %}
      âœ— Traefik config: Will be preserved
      {% endif %}
      {% if homelab_remove_database and homelab_db_check is defined and homelab_db_check.stat.exists %}
      âœ“ Database: {{ homelab_site_path }}/db.sqlite3 âš ï¸  IRREVERSIBLE!
      {% elif homelab_db_check is defined and homelab_db_check.stat.exists %}
      âœ— Database: Will be preserved
      {% endif %}
      {% if homelab_remove_media and homelab_media_check is defined and homelab_media_check.stat.exists %}
      âœ“ Media files: {{ homelab_site_path }}/media/ âš ï¸  IRREVERSIBLE!
      {% elif homelab_media_check is defined and homelab_media_check.stat.exists %}
      âœ— Media files: Will be preserved
      {% endif %}
      {% if homelab_remove_home and homelab_home_check.stat.exists %}
      âœ“ Home directory: {{ homelab_home }}
      {% elif homelab_home_check.stat.exists %}
      âœ— Home directory: Will be preserved
      {% endif %}
      {% if homelab_remove_user and homelab_user_check.ansible_facts.getent_passwd is defined %}
      âœ“ User account: {{ homelab_user }}
      {% elif homelab_user_check.ansible_facts.getent_passwd is defined %}
      âœ— User account: Will be preserved
      {% endif %}

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: Warn about irreversible data deletion
  ansible.builtin.debug:
    msg: |

      âš ï¸  WARNING: DATABASE AND MEDIA WILL BE PERMANENTLY DELETED âš ï¸

      This operation is IRREVERSIBLE. Run `just backup homelab` (or your preferred backup command) before continuing if you have not already captured a snapshot.

      To preserve data, set:
        homelab_remove_database: false
        homelab_remove_media: false
  when: >
    (homelab_remove_database and homelab_db_check is defined and homelab_db_check.stat.exists) or
    (homelab_remove_media and homelab_media_check is defined and homelab_media_check.stat.exists)

- name: Pause for confirmation (if data will be deleted)
  ansible.builtin.pause:
    prompt: |

      Press ENTER to continue with removal, or Ctrl+C to abort.
  when: >
    not homelab_remove_auto_confirm and (
      (homelab_remove_database and homelab_db_check is defined and homelab_db_check.stat.exists) or
      (homelab_remove_media and homelab_media_check is defined and homelab_media_check.stat.exists)
    )
