---
- name: traefik | Ensure Traefik dynamic config directory exists
  ansible.builtin.file:
    path: "{{ open_webui_traefik_config_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: traefik | Ensure htpasswd is installed (apache2-utils)
  ansible.builtin.package:
    name: apache2-utils
    state: present
  when:
    - open_webui_basic_auth_enabled | bool
    - ansible_facts['os_family'] == 'Debian'

- name: traefik | Build basic auth hash from password
  ansible.builtin.command:
    argv:
      - htpasswd
      - -nbB
      - "{{ open_webui_basic_auth_user }}"
      - "{{ open_webui_basic_auth_password }}"
  register: open_webui_basic_auth_htpasswd
  changed_when: false
  no_log: true
  when:
    - open_webui_basic_auth_enabled | bool
    - open_webui_basic_auth_password | length > 0
    - open_webui_basic_auth_password_hash | length == 0

- name: traefik | Set Open WebUI basic auth hash fact
  ansible.builtin.set_fact:
    open_webui_basic_auth_password_hash: "{{ open_webui_basic_auth_htpasswd.stdout.split(':', 1)[1] if open_webui_basic_auth_htpasswd.stdout is defined else open_webui_basic_auth_password_hash }}"
  no_log: true
  when: open_webui_basic_auth_enabled | bool

- name: traefik | Render Traefik configuration for Open WebUI
  ansible.builtin.template:
    src: open-webui-traefik.yml.j2
    dest: "{{ open_webui_traefik_config_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: reload traefik
