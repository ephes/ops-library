---
- name: "mongodb | Ensure keyring directory"
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: "0755"

- name: "mongodb | Download repository key"
  ansible.builtin.get_url:
    url: "https://www.mongodb.org/static/pgp/server-{{ unifi_mongodb_version }}.asc"
    dest: "/usr/share/keyrings/mongodb-server-{{ unifi_mongodb_version }}.asc"
    mode: "0644"

- name: "mongodb | Configure apt repository"
  ansible.builtin.apt_repository:
    repo: "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-{{ unifi_mongodb_version }}.asc ] https://repo.mongodb.org/apt/ubuntu {{ unifi_mongodb_repo_distribution }}/mongodb-org/{{ unifi_mongodb_version }} multiverse"
    state: present
    filename: mongodb-org
    update_cache: true

- name: "mongodb | Install packages"
  ansible.builtin.apt:
    name: "{{ unifi_mongodb_packages }}"
    state: present
    update_cache: true

- name: "mongodb | Configure bind IPs"
  ansible.builtin.lineinfile:
    path: /etc/mongod.conf
    regexp: '^  bindIp:'
    line: "  bindIp: {{ unifi_mongodb_bind_ip_line }}"
    backup: true
  notify: Restart MongoDB

- name: "mongodb | Ensure security block"
  ansible.builtin.lineinfile:
    path: /etc/mongod.conf
    regexp: '^#?security:'
    line: "security:"
    backup: true
  notify: Restart MongoDB

- name: "mongodb | Enable authorization"
  ansible.builtin.lineinfile:
    path: /etc/mongod.conf
    regexp: '^  authorization:'
    line: "  authorization: {{ 'enabled' if unifi_mongodb_enable_auth else 'disabled' }}"
    insertafter: '^security:'
    backup: true
  notify: Restart MongoDB

- name: "mongodb | Ensure quiet logging"
  ansible.builtin.lineinfile:
    path: /etc/mongod.conf
    regexp: '^  quiet:'
    line: "  quiet: true"
    insertafter: '^  path: /var/log/mongodb/mongod.log'
    backup: true
  notify: Restart MongoDB

- name: "mongodb | Ensure verbosity level"
  ansible.builtin.lineinfile:
    path: /etc/mongod.conf
    regexp: '^  verbosity:'
    line: "  verbosity: 0"
    insertafter: '^  quiet: true'
    backup: true
  notify: Restart MongoDB

- name: "mongodb | Configure setParameter block"
  ansible.builtin.blockinfile:
    path: /etc/mongod.conf
    block: |
      # Reduce chattiness for UniFi operation
      setParameter:
        suppressNoTLSPeerCertificateWarning: true
        diagnosticDataCollectionEnabled: false
    marker: "# {mark} ANSIBLE MANAGED - UNIFI"
    insertafter: EOF
    backup: true
  notify: Restart MongoDB

- name: "mongodb | Install logrotate config"
  ansible.builtin.template:
    src: mongodb-logrotate.j2
    dest: "{{ unifi_mongodb_logrotate_path }}"
    owner: "{{ unifi_logrotate_owner }}"
    group: "{{ unifi_logrotate_group }}"
    mode: "0644"
  when: unifi_mongodb_logrotate_enabled | bool

- name: "mongodb | Install log monitor script"
  ansible.builtin.template:
    src: mongodb-log-check.sh.j2
    dest: "{{ unifi_mongodb_monitor_script_path }}"
    mode: "0755"
    owner: "root"
    group: "root"
  when: unifi_mongodb_monitor_script_enabled | bool

- name: "mongodb | Ensure service state"
  ansible.builtin.systemd:
    name: mongod
    state: started
    enabled: true
    daemon_reload: true

- name: "mongodb | Wait for port readiness"
  ansible.builtin.wait_for:
    host: "{{ unifi_mongodb_host }}"
    port: "{{ unifi_mongodb_port }}"
    timeout: "{{ unifi_mongodb_wait_timeout }}"
    delay: 5

# Skip user management entirely if auth is disabled
- name: "mongodb | Check UniFi user authentication"
  ansible.builtin.shell: |
    mongosh --quiet --host {{ unifi_mongodb_host }} --port {{ unifi_mongodb_port }} \
      --authenticationDatabase admin -u "{{ unifi_mongodb_user }}" -p "{{ unifi_mongodb_password }}" \
      --eval "db.runCommand({connectionStatus: 1})" >/dev/null 2>&1
  register: unifi_mongodb_user_check
  changed_when: false
  failed_when: false
  no_log: true
  when: unifi_mongodb_enable_auth | bool

# MongoDB 8.0+ localhost exception doesn't work reliably. Instead, we temporarily
# disable auth, create the user, then re-enable auth.
# This block handles both fresh installs (no users) and password mismatches (user exists).
- name: "mongodb | Create user (auth disabled workflow)"
  when:
    - unifi_mongodb_enable_auth | bool
    - unifi_mongodb_user_check.rc is defined
    - unifi_mongodb_user_check.rc != 0
  block:
    - name: "mongodb | Temporarily disable authorization"
      ansible.builtin.lineinfile:
        path: /etc/mongod.conf
        regexp: '^  authorization:'
        line: "  authorization: disabled"
        backup: true

    - name: "mongodb | Restart MongoDB with auth disabled"
      ansible.builtin.systemd:
        name: mongod
        state: restarted

    - name: "mongodb | Wait for MongoDB to be ready"
      ansible.builtin.wait_for:
        host: "{{ unifi_mongodb_host }}"
        port: "{{ unifi_mongodb_port }}"
        timeout: "{{ unifi_mongodb_wait_timeout }}"
        delay: 2

    - name: "mongodb | Check if user already exists"
      ansible.builtin.shell: |
        mongosh --quiet --host {{ unifi_mongodb_host }} --port {{ unifi_mongodb_port }} admin \
          --eval "db.system.users.countDocuments({user: '{{ unifi_mongodb_user }}'})"
      register: unifi_mongodb_user_exists
      changed_when: false

    - name: "mongodb | Handle user exists (password mismatch)"
      when: (unifi_mongodb_user_exists.stdout | trim | int) > 0
      block:
        - name: "mongodb | Store failure reason"
          ansible.builtin.set_fact:
            unifi_mongodb_failure_reason: "password_mismatch"
            unifi_mongodb_failure_details: >-
              MongoDB user '{{ unifi_mongodb_user }}' exists (count: {{ unifi_mongodb_user_exists.stdout | trim }})
              but authentication with the password from secrets failed.

        - name: "mongodb | Fail with password mismatch"
          ansible.builtin.fail:
            msg: "Password mismatch detected - see final error message after auth is restored."

    - name: "mongodb | Render init script"
      ansible.builtin.template:
        src: mongo-init.js.j2
        dest: /tmp/unifi-mongo-init.js
        owner: root
        group: root
        mode: "0600"
      no_log: true

    - name: "mongodb | Create user"
      ansible.builtin.shell: |
        mongosh --quiet --host {{ unifi_mongodb_host }} --port {{ unifi_mongodb_port }} < /tmp/unifi-mongo-init.js
      register: unifi_mongodb_init
      no_log: true

    - name: "mongodb | Remove init script"
      ansible.builtin.file:
        path: /tmp/unifi-mongo-init.js
        state: absent

  rescue:
    - name: "mongodb | Capture failure context"
      ansible.builtin.set_fact:
        unifi_mongodb_user_creation_failed: true
        unifi_mongodb_failure_reason: "{{ unifi_mongodb_failure_reason | default('user_creation_error') }}"
        unifi_mongodb_failure_details: >-
          {{ unifi_mongodb_failure_details | default(
            'User creation failed. ' ~
            'user_exists check: ' ~ (unifi_mongodb_user_exists.stdout | default('n/a')) ~ ', ' ~
            'init result rc: ' ~ (unifi_mongodb_init.rc | default('n/a')) ~ ', ' ~
            'init stderr: ' ~ (unifi_mongodb_init.stderr | default('n/a'))
          ) }}

    - name: "mongodb | Remove init script on failure"
      ansible.builtin.file:
        path: /tmp/unifi-mongo-init.js
        state: absent
      failed_when: false

  always:
    - name: "mongodb | Restore authorization setting"
      ansible.builtin.lineinfile:
        path: /etc/mongod.conf
        regexp: '^  authorization:'
        line: "  authorization: {{ 'enabled' if unifi_mongodb_enable_auth else 'disabled' }}"
        backup: true

    - name: "mongodb | Restart MongoDB with correct auth setting"
      ansible.builtin.systemd:
        name: mongod
        state: restarted

    - name: "mongodb | Wait for MongoDB to be ready after restoring auth"
      ansible.builtin.wait_for:
        host: "{{ unifi_mongodb_host }}"
        port: "{{ unifi_mongodb_port }}"
        timeout: "{{ unifi_mongodb_wait_timeout }}"
        delay: 2

- name: "mongodb | Fail with detailed error message"
  ansible.builtin.fail:
    msg: |
      MongoDB user management failed. Authorization has been restored to '{{ 'enabled' if unifi_mongodb_enable_auth else 'disabled' }}'.

      Failure reason: {{ unifi_mongodb_failure_reason | default('unknown') }}
      Details: {{ unifi_mongodb_failure_details | default('No additional details available.') }}

      {% if unifi_mongodb_failure_reason | default('') == 'password_mismatch' %}
      To fix this, choose one of these options:

      Option 1: Update the secret to match the existing database password
        - Find the original password that was used when the user was created
        - Update secrets/prod/unifi.yml with that password
        - Re-run the deployment

      Option 2: Drop the existing user and let the role recreate it
        - SSH to the server: ssh root@macmini.tailde2ec.ts.net
        - Disable auth: sudo sed -i 's/authorization: enabled/authorization: disabled/' /etc/mongod.conf
        - Restart MongoDB: sudo systemctl restart mongod
        - Drop the user: mongosh admin --eval "db.dropUser('{{ unifi_mongodb_user }}')"
        - Re-enable auth: sudo sed -i 's/authorization: disabled/authorization: enabled/' /etc/mongod.conf
        - Restart MongoDB: sudo systemctl restart mongod
        - Re-run the deployment: just deploy-one unifi
      {% endif %}
  when: unifi_mongodb_user_creation_failed | default(false)

- name: "mongodb | Verify user was created successfully"
  ansible.builtin.shell: |
    mongosh --quiet --host {{ unifi_mongodb_host }} --port {{ unifi_mongodb_port }} \
      --authenticationDatabase admin -u "{{ unifi_mongodb_user }}" -p "{{ unifi_mongodb_password }}" \
      --eval "db.runCommand({connectionStatus: 1})" >/dev/null 2>&1
  register: unifi_mongodb_user_verify
  changed_when: false
  failed_when: unifi_mongodb_user_verify.rc != 0
  no_log: true
  when:
    - unifi_mongodb_enable_auth | bool
    - unifi_mongodb_user_check.rc is defined
    - unifi_mongodb_user_check.rc != 0
    - not (unifi_mongodb_user_creation_failed | default(false))
